# Trinity Pattern Explanation
## **Best explanation extracted from docs/reference/generated-patterns.md**

### Table Structure

Every SpecQL entity generates a table following the Trinity pattern:

```sql
CREATE TABLE crm.tb_contact (
    -- ========================================================================
    -- Trinity Pattern: INTEGER primary key for performance
    -- ========================================================================
    pk_contact INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- ========================================================================
    -- Trinity Pattern: UUID for stable public API
    -- ========================================================================
    id UUID DEFAULT gen_random_uuid() NOT NULL,

    -- ========================================================================
    -- Multi-Tenancy: Denormalized from JWT (if tenant schema)
    -- ========================================================================
    tenant_id UUID NOT NULL,

    -- ========================================================================
    -- Business Fields (from YAML)
    -- ========================================================================
    email TEXT NOT NULL,
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,

    -- ========================================================================
    -- Foreign Keys (Trinity Pattern: INTEGER references)
    -- ========================================================================
    fk_organization INTEGER,

    -- ========================================================================
    -- Audit Fields (Trinity Pattern standard)
    -- ========================================================================
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by UUID,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by UUID,
    deleted_at TIMESTAMPTZ,
    deleted_by UUID,

    -- ========================================================================
    -- Constraints
    -- ========================================================================
    CONSTRAINT tb_contact_id_key UNIQUE (id)
);
```

### Why Three Identifiers?

The Trinity pattern uses three identifiers because different parts of your system have different needs:

- **Databases** love integers (`pk_contact`) for joins and performance
- **APIs** need stable UUIDs (`id`) that don't leak sequence information
- **Humans** want readable names (`identifier`) like 'john.doe@acme.com'

SpecQL generates all three automatically.

### Helper Functions

Trinity pattern includes helper functions for ID conversion:

```sql
-- Get pk from id (UUID)
CREATE FUNCTION crm.contact_pk(id UUID) RETURNS INTEGER;

-- Get id (UUID) from pk
CREATE FUNCTION crm.contact_id(pk INTEGER) RETURNS UUID;

-- Get identifier from id (UUID)
CREATE FUNCTION crm.contact_identifier(id UUID) RETURNS TEXT;
```

### Foreign Key Pattern

All foreign keys use INTEGER references to primary keys:

```sql
-- Foreign key to organization
fk_organization INTEGER REFERENCES crm.tb_organization(pk_organization);
```

This ensures optimal join performance while maintaining API stability.

---

**Source**: docs/reference/generated-patterns.md
**Quality**: Excellent - clear, comprehensive, shows generated SQL
**Use in**: 03_core-concepts/trinity-pattern.md</content>
</xai:function_call
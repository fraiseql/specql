-- ============================================================================
-- Vector Embeddings: {{ entity.name }}
-- Purpose: Semantic search with pgvector
-- ============================================================================

-- Add embedding column to base table
ALTER TABLE {{ schema }}.tb_{{ entity.name|lower }}
ADD COLUMN embedding vector(384);

-- Add embedding column to table view
ALTER TABLE {{ schema }}.tv_{{ entity.name|lower }}
ADD COLUMN embedding vector(384);

-- ============================================================================
-- HNSW Index for Fast Similarity Search
-- ============================================================================

CREATE INDEX idx_tb_{{ entity.name|lower }}_embedding_hnsw
ON {{ schema }}.tb_{{ entity.name|lower }}
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

COMMENT ON INDEX {{ schema }}.idx_tb_{{ entity.name|lower }}_embedding_hnsw IS
'HNSW index for fast vector similarity search on {{ entity.name }}.
- m = 16: Number of connections per layer
- ef_construction = 64: Quality of index construction
- Operator: <=> (cosine distance)';

-- ============================================================================
-- Similarity Search Function
-- ============================================================================

CREATE OR REPLACE FUNCTION {{ schema }}.search_{{ entity.name|lower }}_by_embedding(
    p_query_embedding vector(384),
    p_limit INTEGER DEFAULT 10,
    p_min_similarity FLOAT DEFAULT 0.0
)
RETURNS TABLE (
    pk INTEGER,
    id UUID,
    similarity FLOAT,
    data JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        tv.pk_{{ entity.name|lower }},
        tv.id,
        1 - (tv.embedding <=> p_query_embedding) AS similarity,
        tv.data
    FROM {{ schema }}.tv_{{ entity.name|lower }} tv
    WHERE tv.embedding IS NOT NULL
        AND (1 - (tv.embedding <=> p_query_embedding)) >= p_min_similarity
    ORDER BY tv.embedding <=> p_query_embedding
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql STABLE;

COMMENT ON FUNCTION {{ schema }}.search_{{ entity.name|lower }}_by_embedding IS
'Semantic similarity search for {{ entity.name }} using vector embeddings.

Args:
- p_query_embedding: Query vector (384 dimensions)
- p_limit: Maximum results to return
- p_min_similarity: Minimum similarity threshold (0.0 - 1.0)

Returns:
- Matching entities with similarity scores, ordered by relevance

@fraiseql:query
name: search{{ entity.name }}ByEmbedding
type: [{{ entity.name }}!]!
args:
  - queryEmbedding: [Float!]!
  - limit: Int
  - minSimilarity: Float';
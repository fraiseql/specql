{# ============================================================================ #}
{# Jinja2 Template: PostgreSQL Table Generation (Trinity Pattern) #}
{# ============================================================================ #}
-- ============================================================================
-- Table: {{ entity.schema }}.tb_{{ entity.name }}
-- ============================================================================
-- [Table: {{ entity.table_code }} | {{ entity.description }}]
-- ============================================================================

CREATE TABLE {{ entity.schema }}.tb_{{ entity.name }} (
    -- ========================================================================
    -- Trinity Pattern: INTEGER primary key for performance
    -- ========================================================================
    pk_{{ entity.name }} INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- ========================================================================
    -- Trinity Pattern: UUID for stable public API
    -- ========================================================================
    id UUID DEFAULT gen_random_uuid() NOT NULL,

    -- ========================================================================
    -- Business Fields
    -- ========================================================================
{%- for field_name, field_def in entity.fields.items() %}
    {{ field_name }} {{ field_def.type }}{% if not field_def.nullable %} NOT NULL{% endif %},
{%- endfor %}

    -- ========================================================================
    -- Foreign Keys (Trinity Pattern: INTEGER references)
    -- ========================================================================
{%- for fk_name, fk_def in entity.foreign_keys.items() %}
    {{ fk_name }} INTEGER{% if not fk_def.nullable %} NOT NULL{% endif %},
{%- endfor %}

    -- ========================================================================
    -- Audit Fields (Trinity Pattern standard)
    -- ========================================================================
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by UUID,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by UUID,
    deleted_at TIMESTAMPTZ,
    deleted_by UUID,

    -- ========================================================================
    -- Constraints
    -- ========================================================================
    CONSTRAINT tb_{{ entity.name }}_id_key UNIQUE (id)
{%- for field_name, field_def in entity.fields.items() %}
{%- if field_def.get('unique') %}
    ,CONSTRAINT tb_{{ entity.name }}_{{ field_name }}_key UNIQUE ({{ field_name }})
{%- endif %}
{%- endfor %}
);

-- ============================================================================
-- Foreign Key Constraints (defined after table creation)
-- ============================================================================
{%- for fk_name, fk_def in entity.foreign_keys.items() %}

ALTER TABLE ONLY {{ entity.schema }}.tb_{{ entity.name }}
    ADD CONSTRAINT tb_{{ entity.name }}_{{ fk_name }}_fkey
    FOREIGN KEY ({{ fk_name }}) REFERENCES {{ fk_def.references }}({{ fk_def.on }});
{%- endfor %}

-- ============================================================================
-- Documentation
-- ============================================================================
COMMENT ON TABLE {{ entity.schema }}.tb_{{ entity.name }} IS '[Table: {{ entity.table_code }} | {{ entity.description }}]';

-- Trinity Pattern columns
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.pk_{{ entity.name }} IS 'Internal INTEGER primary key used in joins and foreign keys.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.id IS 'Public UUID identifier for external APIs and GraphQL.';

-- Business field columns
{%- for field_name, field_def in entity.fields.items() %}
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.{{ field_name }} IS '{{ field_def.description }}';
{%- endfor %}

-- Foreign key columns
{%- for fk_name, fk_def in entity.foreign_keys.items() %}
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.{{ fk_name }} IS '{{ fk_def.description }}';
{%- endfor %}

-- Audit field columns
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.created_at IS 'Timestamp when the record was created.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.created_by IS 'User or system who created the record.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.updated_at IS 'Timestamp when the record was last updated.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.updated_by IS 'User or system who last updated the record.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.deleted_at IS 'Timestamp of soft deletion.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name }}.deleted_by IS 'User or system who deleted the record.';

{%- if entity.translations.enabled %}

-- ============================================================================
-- Translation Table: {{ entity.schema }}.{{ entity.translations.table_name }}
-- ============================================================================
CREATE TABLE {{ entity.schema }}.{{ entity.translations.table_name }} (
    fk_{{ entity.name }} INTEGER NOT NULL
        REFERENCES {{ entity.schema }}.tb_{{ entity.name }}(pk_{{ entity.name }}) ON DELETE CASCADE,
    locale TEXT NOT NULL
        REFERENCES tb_locale(code) ON DELETE CASCADE,
{%- for field in entity.translations.fields %}
    {{ field }} TEXT,
{%- endfor %}
    PRIMARY KEY (fk_{{ entity.name }}, locale)
);

-- Documentation
COMMENT ON TABLE {{ entity.schema }}.{{ entity.translations.table_name }} IS 'Provides localized translations for {{ entity.name }}.';
COMMENT ON COLUMN {{ entity.schema }}.{{ entity.translations.table_name }}.fk_{{ entity.name }} IS 'Reference to the {{ entity.name }}.';
COMMENT ON COLUMN {{ entity.schema }}.{{ entity.translations.table_name }}.locale IS 'Locale code (e.g., "fr-FR", "en-US").';
{%- for field in entity.translations.fields %}
COMMENT ON COLUMN {{ entity.schema }}.{{ entity.translations.table_name }}.{{ field }} IS 'Localized {{ field }} for the {{ entity.name }}.';
{%- endfor %}
{%- endif %}

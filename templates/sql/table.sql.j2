{# ============================================================================ #}
{# Jinja2 Template: PostgreSQL Table Generation (Trinity Pattern) #}
{# ============================================================================ #}
-- ============================================================================
-- Table: {{ entity.schema }}.tb_{{ entity.name | lower }}
-- ============================================================================
-- [Table: {{ entity.table_code }} | {{ entity.description }}]
-- ============================================================================

CREATE TABLE {{ entity.schema }}.tb_{{ entity.name | lower }} (
    -- ========================================================================
    -- Trinity Pattern: INTEGER primary key for performance
    -- ========================================================================
    pk_{{ entity.name | lower }} INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- ========================================================================
    -- Trinity Pattern: UUID for stable public API
    -- ========================================================================
    id UUID DEFAULT gen_random_uuid() NOT NULL,

{%- if entity.multi_tenant %}

    -- ========================================================================
    -- Multi-Tenancy: Denormalized from JWT (CRITICAL for security)
    -- ========================================================================
    tenant_id UUID NOT NULL,

    -- ========================================================================
    -- Multi-Tenancy: Optional business FK to organization
    -- ========================================================================
    -- Note: Only add fk_organization if entity belongs to specific org unit
    -- (not just tenant isolation). Comment out if not needed.
    -- fk_organization INTEGER,
{%- endif %}

    -- ========================================================================
    -- Business Fields
    -- ========================================================================
{%- for field_name, field_def in entity.fields.items() %}
{%- if field_def.is_computed %}

    {{ field_name }} {{ field_def.type_name }} GENERATED ALWAYS AS ({{ field_def.computed_expression }}) STORED{% if not field_def.nullable %} NOT NULL{% endif %},
{%- else %}

    {{ field_name }} {{ field_def.type }}{% if not field_def.nullable %} NOT NULL{% endif %},
{%- endif %}
{%- endfor %}
{%- for computed_col in entity.patterns.computed_columns %}

     {{ computed_col.name }} {{ computed_col.type }} GENERATED ALWAYS AS ({{ computed_col.expression }}) STORED,
{%- endfor %}
{%- for scd_field in entity.patterns.scd_fields %}

     {{ scd_field.name }} {{ scd_field.type }}{% if not scd_field.nullable %} NOT NULL{% endif %}{% if scd_field.default %} DEFAULT {{ scd_field.default }}{% endif %},
{%- endfor %}
{%- for ti_field in entity.patterns.template_inheritance_fields %}
{%- if ti_field.get('fk') %}

     {{ ti_field.fk.name }} INTEGER{% if not ti_field.fk.nullable %} NOT NULL{% endif %},
{%- else %}

     {{ ti_field.name }} {{ ti_field.type }}{% if not ti_field.nullable %} NOT NULL{% endif %},
{%- endif %}
{%- endfor %}

    -- ========================================================================
    -- Foreign Keys (Trinity Pattern: INTEGER references)
    -- ========================================================================
{% for fk_name, fk_def in entity.foreign_keys.items() %}

    {{ fk_name }} INTEGER{% if not fk_def.nullable %} NOT NULL{% endif %},
{% endfor %}

    -- ========================================================================
    -- Audit Fields (Trinity Pattern standard)
    -- ========================================================================
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by UUID,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by UUID,
    deleted_at TIMESTAMPTZ,
    deleted_by UUID,

    -- ========================================================================
    -- Constraints
    -- ========================================================================
    CONSTRAINT tb_{{ entity.name | lower }}_id_key UNIQUE (id)
{%- for field_name, field_def in entity.fields.items() %}
{%- if field_def.get('unique') %}

    ,CONSTRAINT tb_{{ entity.name | lower }}_{{ field_name }}_key UNIQUE ({{ field_name }})
{%- endif %}
{%- endfor %}
{%- for constraint in entity.constraints %}

    ,{{ constraint }}
{%- endfor %}
);

-- ============================================================================
-- Foreign Key Constraints (defined after table creation)
-- ============================================================================
{%- for fk_name, fk_def in entity.foreign_keys.items() %}

ALTER TABLE ONLY {{ entity.schema }}.tb_{{ entity.name | lower }}
    ADD CONSTRAINT tb_{{ entity.name | lower }}_{{ fk_name }}_fkey
    FOREIGN KEY ({{ fk_name }}) REFERENCES {{ fk_def.references }}({{ fk_def.on }});
{%- endfor %}

{%- for excl_constraint in entity.patterns.exclusion_constraints %}
-- ============================================================================
-- Pattern Exclusion Constraints
-- ============================================================================
ALTER TABLE {{ entity.schema }}.tb_{{ entity.name | lower }}
    ADD CONSTRAINT {{ excl_constraint.name }}
    EXCLUDE USING {{ excl_constraint.using }} (
        {% for col in excl_constraint.columns %}
        {{ col.field }} WITH {{ col.operator }}{% if not loop.last %}, {% endif %}
        {% endfor %}
    ){% if excl_constraint.condition %} WHERE {{ excl_constraint.condition }}{% endif %};
{%- endfor %}

{%- if entity.multi_tenant %}
-- ============================================================================
-- Multi-Tenancy Indexes (CRITICAL for performance & RLS)
-- ============================================================================
CREATE INDEX idx_tb_{{ entity.name | lower }}_tenant ON {{ entity.schema }}.tb_{{ entity.name | lower }}(tenant_id);
{%- endif %}

{%- for index in entity.patterns.indexes %}
-- ============================================================================
-- Pattern Indexes
-- ============================================================================
CREATE INDEX {{ index.name }} ON {{ entity.schema }}.tb_{{ entity.name | lower }}{% if index.type and index.type != 'btree' %} USING {{ index.type }}{% endif %} ({% for field in index.columns %}{{ field }}{% if not loop.last %}, {% endif %}{% endfor %});
{%- endfor %}

{%- for agg_view in entity.patterns.aggregate_views %}
-- ============================================================================
-- Aggregate View: {{ agg_view.name }}
-- ============================================================================
{{ agg_view.ddl }}

{%- if agg_view.trigger_ddl %}

{{ agg_view.trigger_ddl }}
{%- endif %}
{%- endfor %}

{%- for idx in entity.patterns.aggregate_view_indexes %}
{{ idx }}
{%- endfor %}

{%- for idx in entity.patterns.scd_indexes %}
-- ============================================================================
-- SCD Index: {{ idx.name }}
-- ============================================================================
CREATE INDEX {{ idx.name }} ON {{ entity.schema }}.tb_{{ entity.name | lower }}{% if idx.type and idx.type != 'btree' %} USING {{ idx.type }}{% endif %} ({% for col in idx.columns %}{{ col }}{% if not loop.last %}, {% endif %}{% endfor %});
{%- endfor %}

{%- for func in entity.patterns.scd_functions %}
-- ============================================================================
-- SCD Function
-- ============================================================================
{{ func }}
{%- endfor %}

{%- for func in entity.patterns.template_inheritance_functions %}
-- ============================================================================
-- Template Inheritance Function
-- ============================================================================
{{ func }}
{%- endfor %}

{%- for trigger in entity.patterns.template_inheritance_triggers %}
-- ============================================================================
-- Template Inheritance Trigger
-- ============================================================================
{{ trigger }}
{%- endfor %}

{%- for idx in entity.patterns.template_inheritance_indexes %}
-- ============================================================================
-- Template Inheritance Index: {{ idx.name }}
-- ============================================================================
CREATE INDEX {{ idx.name }} ON {{ entity.schema }}.tb_{{ entity.name | lower }}{% if idx.using %} USING {{ idx.using }}{% endif %} ({% for field in idx.fields %}{{ field }}{% if not loop.last %}, {% endif %}{% endfor %});
{%- endfor %}

-- ============================================================================
-- Documentation
-- ============================================================================
COMMENT ON TABLE {{ entity.schema }}.tb_{{ entity.name | lower }} IS
'{{ entity.description }}.

@fraiseql:type
trinity: true
{% for meta in entity.patterns.metadata %}{{ meta }}
{% endfor %}';

-- Trinity Pattern columns
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.pk_{{ entity.name | lower }} IS 'Internal INTEGER primary key used in joins and foreign keys.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.id IS
'Public UUID identifier for external APIs and GraphQL.

@fraiseql:field
name: id
type: UUID!
required: true';
{%- if entity.multi_tenant %}

-- Multi-Tenancy columns
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.tenant_id IS 'Denormalized tenant identifier from JWT token (security context).';
-- COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.fk_organization IS 'Optional business FK to organization unit (uncomment if needed).';
{%- endif %}

-- Business field columns (comments handled by CommentGenerator)

-- Foreign key columns (comments handled by CommentGenerator)

-- Audit field columns
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.created_at IS 'Timestamp when the record was created.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.created_by IS 'User or system who created the record.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.updated_at IS 'Timestamp when the record was last updated.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.updated_by IS 'User or system who last updated the record.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.deleted_at IS 'Timestamp of soft deletion.';
COMMENT ON COLUMN {{ entity.schema }}.tb_{{ entity.name | lower }}.deleted_by IS 'User or system who deleted the record.';

{# Translation tables are now generated separately by TranslationTableGenerator #}

pattern: schema_computed_column
version: 1.0
category: schema
description: |
  Add GENERATED ALWAYS AS computed columns with automatic indexing.
  Supports both STORED (precomputed) and VIRTUAL (computed on read).

parameters:
- name: column_name
  type: string
  required: true
  description: "Name of computed column"
  validation: "^[a-z][a-z0-9_]*$"

- name: expression
  type: string
  required: true
  description: "SQL expression for computed value"
  example: "LOWER(email)"

- name: type
  type: string
  required: true
  description: "PostgreSQL type of result"
  example: "text"

- name: stored
  type: boolean
  default: true
  description: "STORED (precomputed) vs VIRTUAL (computed on read)"

- name: index
  type: boolean
  default: false
  description: "Create index on computed column"

- name: index_type
  type: enum
  values: [btree, gin, gist, hash]
  default: btree
  description: "Type of index to create"

- name: comment
  type: string
  default: ""
  description: "Column comment"

schema_extensions:
  computed_columns:
  - name: "{{ column_name }}"
    type: "{{ type }}"
    expression: "{{ expression }}"
    stored: "{{ stored }}"
    comment: "{{ comment or 'Computed: ' + expression }}"

  indexes:
  - name: "idx_{{ entity.name | lower }}_{{ column_name }}"
    fields: ["{{ column_name }}"]
    using: "{{ index_type }}"
    when: "{{ index }}"
    comment: "Index on computed column {{ column_name }}"

examples:
- name: Email normalization
  yaml: |
    entity: User
    fields:
      email: text
    patterns:
      - type: schema_computed_column
        params:
          column_name: email_normalized
          expression: "LOWER(TRIM(email))"
          type: text
          stored: true
          index: true

  generated:
  - email_normalized text GENERATED ALWAYS AS (LOWER(TRIM(email))) STORED
  - CREATE INDEX idx_user_email_normalized ON tb_user(email_normalized);

- name: Full name concatenation
  yaml: |
    entity: Contact
    fields:
      first_name: text
      last_name: text
    patterns:
      - type: schema_computed_column
        params:
          column_name: full_name
          expression: "first_name || ' ' || last_name"
          type: text
          stored: false

  generated:
  - full_name text GENERATED ALWAYS AS (first_name || ' ' || last_name) VIRTUAL

- name: Price with tax
  yaml: |
    entity: Product
    fields:
      base_price: decimal
      tax_rate: decimal
    patterns:
      - type: schema_computed_column
        params:
          column_name: price_with_tax
          expression: "base_price * (1 + tax_rate)"
          type: decimal
          stored: true

  generated:
  - price_with_tax decimal GENERATED ALWAYS AS (base_price * (1 + tax_rate)) STORED

performance:
- operation: Read STORED column
  complexity: O(1)
  notes: "Same as normal column, value is precomputed"

- operation: Read VIRTUAL column
  complexity: O(1) + cost of expression
  notes: "Computed on every read, use for rarely accessed columns"

- operation: Index on STORED column
  complexity: O(log n)
  notes: "Full index performance, recommended for queries"

limitations:
- "VIRTUAL columns cannot have indexes (PostgreSQL limitation pre-v15)"
- "Expression cannot reference other computed columns"
- "Expression must be deterministic (no now(), random(), etc.)"

best_practices:
- "Use STORED for frequently queried columns"
- "Use VIRTUAL for derived data rarely accessed"
- "Index STORED computed columns used in WHERE/ORDER BY"
- "Keep expressions simple for better performance"

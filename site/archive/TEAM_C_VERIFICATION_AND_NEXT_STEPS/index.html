<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Team C: Verification &amp; Detailed Next Steps Plan - SpecQL Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Team C: Verification \u0026amp; Detailed Next Steps Plan";
        var mkdocs_page_input_path = "archive/TEAM_C_VERIFICATION_AND_NEXT_STEPS.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> SpecQL Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../getting-started/">Getting Started</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../guides/mutation-patterns/">Mutation Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../guides/test-generation/">Test Generation</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../guides/cli/">CLI</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../reference/">Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../examples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../tutorials/">Tutorials</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../best-practices/">Best Practices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">SpecQL Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Team C: Verification &amp; Detailed Next Steps Plan</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="team-c-verification-detailed-next-steps-plan">Team C: Verification &amp; Detailed Next Steps Plan</h1>
<p><strong>Date</strong>: 2025-11-08
<strong>Status</strong>: ‚úÖ Mostly Complete - Ready for Final Integration
<strong>Progress</strong>: ~85% Complete</p>
<hr />
<h2 id="verification-results">‚úÖ VERIFICATION RESULTS</h2>
<h3 id="1-naming-convention-check-correct">1. Naming Convention Check ‚úÖ CORRECT</h3>
<p><strong>Templates</strong>: All using CORRECT Trinity pattern naming</p>
<pre><code class="language-bash">‚úÖ templates/sql/app_wrapper.sql.j2 - Uses auth_tenant_id, auth_user_id
‚úÖ templates/sql/core_create_function.sql.j2 - Uses auth_tenant_id, auth_user_id
‚úÖ templates/sql/core_update_function.sql.j2 - Uses auth_tenant_id, auth_user_id
‚úÖ templates/sql/core_delete_function.sql.j2 - Uses auth_tenant_id, auth_user_id
</code></pre>
<p><strong>Generators</strong>: Using correct naming</p>
<pre><code class="language-bash">‚úÖ src/generators/app_wrapper_generator.py - Templates use correct params
‚úÖ src/generators/core_logic_generator.py - References auth_tenant_id, auth_user_id
</code></pre>
<p><strong>Variable Naming</strong>: ‚úÖ CORRECT
- Templates use <code>v_{entity}_id</code> (e.g., <code>v_contact_id</code>)
- Templates use <code>v_{entity}_pk</code> (e.g., <code>v_contact_pk</code>)
- No ambiguous <code>v_id</code> found</p>
<h3 id="2-helper-function-schema-correct">2. Helper Function Schema ‚úÖ CORRECT</h3>
<p>All templates correctly use:</p>
<pre><code class="language-sql">‚úÖ app.log_and_return_mutation(...)  -- Shared utility in app schema
‚ùå NOT crm.log_and_return_mutation()  -- Would duplicate per schema
</code></pre>
<p><strong>Count</strong>:
- <code>app.log_and_return_mutation</code>: 9 occurrences across templates ‚úÖ
- <code>{schema}.log_and_return_mutation</code>: 0 occurrences ‚úÖ</p>
<h3 id="3-test-status">3. Test Status</h3>
<p><strong>App Wrapper Tests</strong>: ‚úÖ 7/7 PASSING</p>
<pre><code>‚úÖ test_generate_app_wrapper_for_create_action
‚úÖ test_app_wrapper_jwt_context_parameters
‚úÖ test_app_wrapper_uses_team_b_composite_type
‚úÖ test_app_wrapper_for_update_action
‚úÖ test_app_wrapper_for_delete_action
‚úÖ test_app_wrapper_error_handling
‚úÖ test_app_wrapper_fraiseql_annotation
</code></pre>
<p><strong>Core Logic Tests</strong>: ‚ö†Ô∏è 4/5 PASSING (1 minor fix needed)</p>
<pre><code>‚ùå test_generate_core_create_function - Expects crm.log_and_return_mutation (needs update)
‚úÖ test_core_function_uses_trinity_helpers
‚úÖ test_core_function_populates_audit_fields
‚úÖ test_core_function_populates_tenant_id
‚úÖ test_core_function_uses_trinity_naming
</code></pre>
<p><strong>Issue</strong>: One test assertion expects the OLD pattern (<code>crm.log_and_return_mutation</code>), but the template correctly generates the NEW pattern (<code>app.log_and_return_mutation</code>).</p>
<p><strong>Fix Required</strong>:</p>
<pre><code class="language-python"># tests/unit/generators/test_core_logic_generator.py:39
# Change:
assert &quot;RETURN crm.log_and_return_mutation&quot; in sql
# To:
assert &quot;RETURN app.log_and_return_mutation&quot; in sql
</code></pre>
<hr />
<h2 id="current-state-summary">üìä CURRENT STATE SUMMARY</h2>
<h3 id="whats-complete">What's Complete ‚úÖ</h3>
<h4 id="phase-1-appcore-function-generation-100"><strong>Phase 1: App/Core Function Generation</strong> (100%)</h4>
<ul>
<li>‚úÖ <code>AppWrapperGenerator</code> - Generates app.* API wrappers</li>
<li>‚úÖ <code>CoreLogicGenerator</code> - Generates core business logic functions</li>
<li>‚úÖ Templates for create/update/delete operations</li>
<li>‚úÖ Correct Trinity pattern naming throughout</li>
<li>‚úÖ Correct helper function schema (app.*)</li>
<li>‚úÖ JWT context parameter handling</li>
<li>‚úÖ Composite type integration</li>
<li>‚úÖ FraiseQL annotations</li>
</ul>
<h4 id="phase-2-action-compilation-infrastructure-80"><strong>Phase 2: Action Compilation Infrastructure</strong> (~80%)</h4>
<ul>
<li>‚úÖ <code>action_compiler.py</code> - Main action compilation orchestrator</li>
<li>‚úÖ <code>function_scaffolding.py</code> - Basic function structure generation</li>
<li>‚úÖ <code>validation_step_compiler.py</code> - Validation step compilation</li>
<li>‚úÖ <code>database_operation_compiler.py</code> - INSERT/UPDATE/DELETE operations</li>
<li>‚úÖ <code>conditional_compiler.py</code> - if/then/else compilation</li>
<li>‚úÖ <code>impact_metadata_compiler.py</code> - FraiseQL impact metadata</li>
<li>‚úÖ <code>composite_type_builder.py</code> - Type-safe composite type builders</li>
<li>‚úÖ <code>trinity_resolver.py</code> - UUID‚ÜíINTEGER resolution</li>
</ul>
<h4 id="phase-3-step-compilers-70"><strong>Phase 3: Step Compilers</strong> (70%)</h4>
<ul>
<li>‚úÖ <code>step_compilers/validate_compiler.py</code> - Validation steps</li>
<li>‚úÖ <code>step_compilers/insert_compiler.py</code> - Insert operations</li>
<li>‚úÖ <code>step_compilers/update_compiler.py</code> - Update operations</li>
<li>‚úÖ <code>step_compilers/delete_compiler.py</code> - Delete operations</li>
<li>‚úÖ <code>step_compilers/if_compiler.py</code> - Conditional logic</li>
<li>‚úÖ <code>step_compilers/fk_resolver.py</code> - Foreign key resolution</li>
<li>‚úÖ <code>step_compilers/rich_type_handler.py</code> - Rich scalar type handling</li>
</ul>
<h3 id="whats-incomplete">What's Incomplete ‚ö†Ô∏è</h3>
<h4 id="missing-full-integration-tests-0"><strong>Missing: Full Integration Tests</strong> (0%)</h4>
<ul>
<li>‚ùå End-to-end: SpecQL YAML ‚Üí Generated SQL ‚Üí PostgreSQL execution</li>
<li>‚ùå FraiseQL introspection of generated functions</li>
<li>‚ùå Multi-entity action compilation</li>
<li>‚ùå Complex action workflows (multiple steps, conditionals, etc.)</li>
</ul>
<h4 id="missing-advanced-action-features-0"><strong>Missing: Advanced Action Features</strong> (0%)</h4>
<ul>
<li>‚ùå Loop/iteration steps (for_each)</li>
<li>‚ùå Call steps (invoke other functions)</li>
<li>‚ùå Notify steps (event emission)</li>
<li>‚ùå Complex expression parsing (nested conditions, SQL functions)</li>
<li>‚ùå Transaction control (savepoints, rollback)</li>
</ul>
<h4 id="missing-error-handling-edge-cases-30"><strong>Missing: Error Handling &amp; Edge Cases</strong> (30%)</h4>
<ul>
<li>‚ö†Ô∏è Partial: Basic validation errors</li>
<li>‚ùå SQL injection protection</li>
<li>‚ùå Circular dependency detection</li>
<li>‚ùå Invalid action step combinations</li>
<li>‚ùå Type mismatch handling</li>
</ul>
<h4 id="missing-team-b-dependency-critical"><strong>Missing: Team B Dependency</strong> (CRITICAL)</h4>
<ul>
<li>‚ùå <code>app.log_and_return_mutation()</code> function <strong>NOT YET GENERATED</strong></li>
<li>‚ùå Team B must add this to base app schema generation</li>
</ul>
<hr />
<h2 id="detailed-next-steps">üéØ DETAILED NEXT STEPS</h2>
<h3 id="immediate-today-30-minutes"><strong>IMMEDIATE (Today) - 30 minutes</strong></h3>
<h4 id="task-1-fix-failing-test">Task 1: Fix Failing Test</h4>
<pre><code class="language-bash"># File: tests/unit/generators/test_core_logic_generator.py
# Line: 39

# Change:
assert &quot;RETURN crm.log_and_return_mutation&quot; in sql

# To:
assert &quot;RETURN app.log_and_return_mutation&quot; in sql
</code></pre>
<p><strong>Verification</strong>:</p>
<pre><code class="language-bash">uv run pytest tests/unit/generators/test_core_logic_generator.py::test_generate_core_create_function -v
# Should: PASS
</code></pre>
<h4 id="task-2-add-applog_and_return_mutation-to-team-b-generator">Task 2: Add <code>app.log_and_return_mutation</code> to Team B Generator</h4>
<p><strong>File</strong>: <code>src/generators/schema/schema_generator.py</code> or new <code>src/generators/app_foundation_generator.py</code></p>
<p><strong>Add Method</strong>:</p>
<pre><code class="language-python">def generate_app_log_and_return_mutation(self) -&gt; str:
    &quot;&quot;&quot;Generate shared app.log_and_return_mutation utility function&quot;&quot;&quot;
    return &quot;&quot;&quot;
-- ============================================================================
-- SHARED UTILITY: app.log_and_return_mutation
-- Used by ALL business schemas for standardized mutation responses
-- ============================================================================
CREATE OR REPLACE FUNCTION app.log_and_return_mutation(
    p_tenant_id UUID,
    p_user_id UUID,
    p_entity TEXT,
    p_entity_id UUID,
    p_operation TEXT,
    p_status TEXT,
    p_updated_fields TEXT[],
    p_message TEXT,
    p_object_data JSONB,
    p_extra_metadata JSONB DEFAULT NULL
) RETURNS app.mutation_result
LANGUAGE plpgsql
AS $$
DECLARE
    v_result app.mutation_result;
BEGIN
    -- TODO Phase 2: Insert into app.tb_mutation_audit for tracking
    -- INSERT INTO app.tb_mutation_audit (
    --     tenant_id, user_id, entity, entity_id, operation, status,
    --     updated_fields, message, timestamp
    -- ) VALUES (
    --     p_tenant_id, p_user_id, p_entity, p_entity_id, p_operation, p_status,
    --     p_updated_fields, p_message, now()
    -- );

    -- Build standardized result
    v_result.id := p_entity_id;
    v_result.updated_fields := p_updated_fields;
    v_result.status := p_status;
    v_result.message := p_message;
    v_result.object_data := p_object_data;
    v_result.extra_metadata := COALESCE(p_extra_metadata, '{}'::jsonb);

    RETURN v_result;
END;
$$;

COMMENT ON FUNCTION app.log_and_return_mutation IS
  '@fraiseql:utility Shared utility for building mutation_result responses';
&quot;&quot;&quot;
</code></pre>
<p><strong>Integration</strong>: Ensure this is generated in <code>migrations/000_app_foundation.sql</code> BEFORE any entity migrations.</p>
<p><strong>Verification</strong>:</p>
<pre><code class="language-bash"># Generate a test entity
uv run python -m src.cli.generate entities/examples/contact_lightweight.yaml

# Check migration includes helper
grep -n &quot;app.log_and_return_mutation&quot; migrations/*.sql
# Should find it in 000_app_foundation.sql
</code></pre>
<hr />
<h3 id="short-term-this-week-2-3-days"><strong>SHORT TERM (This Week) - 2-3 days</strong></h3>
<h4 id="task-3-complete-integration-testing">Task 3: Complete Integration Testing</h4>
<p><strong>Create</strong>: <code>tests/integration/actions/test_full_action_compilation.py</code></p>
<pre><code class="language-python">&quot;&quot;&quot;
Integration tests for full action compilation pipeline
SpecQL ‚Üí SQL ‚Üí PostgreSQL ‚Üí Execution
&quot;&quot;&quot;

import pytest
from src.core.specql_parser import SpecQLParser
from src.generators.schema_orchestrator import SchemaOrchestrator
from tests.integration.conftest import db_connection


def test_full_create_contact_compilation_and_execution(db_connection):
    &quot;&quot;&quot;
    Full pipeline test:
    1. Parse SpecQL YAML
    2. Generate SQL (schema + functions)
    3. Apply to test database
    4. Execute function
    5. Verify result structure
    &quot;&quot;&quot;
    # Parse SpecQL
    entity = SpecQLParser().parse(&quot;entities/examples/contact_lightweight.yaml&quot;)

    # Generate complete migration
    orchestrator = SchemaOrchestrator()
    migration_sql = orchestrator.generate_complete_migration(entity)

    # Apply to database
    db_connection.execute(migration_sql)

    # Execute function
    result = db_connection.query(&quot;&quot;&quot;
        SELECT app.create_contact(
            auth_tenant_id := gen_random_uuid(),
            auth_user_id := gen_random_uuid(),
            input_payload := '{&quot;email&quot;: &quot;test@example.com&quot;, &quot;status&quot;: &quot;lead&quot;}'::jsonb
        );
    &quot;&quot;&quot;)

    # Verify result structure
    assert result[&quot;status&quot;] == &quot;success&quot;
    assert result[&quot;message&quot;] == &quot;Contact created successfully&quot;
    assert result[&quot;object_data&quot;][&quot;email&quot;] == &quot;test@example.com&quot;
    assert result[&quot;object_data&quot;][&quot;__typename&quot;] == &quot;Contact&quot;
    assert &quot;id&quot; in result[&quot;object_data&quot;]


def test_validation_error_returns_proper_structure(db_connection):
    &quot;&quot;&quot;Test that validation errors return proper mutation_result&quot;&quot;&quot;
    # Apply schema
    setup_contact_schema(db_connection)

    # Call with missing required field
    result = db_connection.query(&quot;&quot;&quot;
        SELECT app.create_contact(
            auth_tenant_id := gen_random_uuid(),
            auth_user_id := gen_random_uuid(),
            input_payload := '{}'::jsonb  -- Missing email
        );
    &quot;&quot;&quot;)

    # Verify error structure
    assert result[&quot;status&quot;] == &quot;failed:missing_email&quot;
    assert &quot;Email is required&quot; in result[&quot;message&quot;]
    assert result[&quot;object_data&quot;] is None


def test_trinity_resolution_in_action(db_connection):
    &quot;&quot;&quot;Test UUID‚ÜíINTEGER FK resolution works in compiled actions&quot;&quot;&quot;
    # Setup company and contact schemas
    setup_company_schema(db_connection)
    setup_contact_schema(db_connection)

    # Create company
    company_result = db_connection.query(&quot;&quot;&quot;
        SELECT app.create_company(
            auth_tenant_id := gen_random_uuid(),
            auth_user_id := gen_random_uuid(),
            input_payload := '{&quot;name&quot;: &quot;ACME Corp&quot;}'::jsonb
        );
    &quot;&quot;&quot;)
    company_id = company_result[&quot;object_data&quot;][&quot;id&quot;]

    # Create contact with company reference
    contact_result = db_connection.query(f&quot;&quot;&quot;
        SELECT app.create_contact(
            auth_tenant_id := gen_random_uuid(),
            auth_user_id := gen_random_uuid(),
            input_payload := '{{&quot;email&quot;: &quot;john@acme.com&quot;, &quot;company_id&quot;: &quot;{company_id}&quot;}}'::jsonb
        );
    &quot;&quot;&quot;)

    # Verify FK was resolved and inserted
    assert contact_result[&quot;status&quot;] == &quot;success&quot;
    assert contact_result[&quot;object_data&quot;][&quot;company&quot;][&quot;name&quot;] == &quot;ACME Corp&quot;


def test_update_action_compilation(db_connection):
    &quot;&quot;&quot;Test UPDATE action compilation and execution&quot;&quot;&quot;
    setup_contact_schema(db_connection)

    # Create contact
    create_result = create_test_contact(db_connection)
    contact_id = create_result[&quot;object_data&quot;][&quot;id&quot;]

    # Update contact
    update_result = db_connection.query(f&quot;&quot;&quot;
        SELECT app.update_contact(
            auth_tenant_id := gen_random_uuid(),
            auth_user_id := gen_random_uuid(),
            input_payload := '{{&quot;id&quot;: &quot;{contact_id}&quot;, &quot;status&quot;: &quot;qualified&quot;}}'::jsonb
        );
    &quot;&quot;&quot;)

    # Verify
    assert update_result[&quot;status&quot;] == &quot;success&quot;
    assert update_result[&quot;object_data&quot;][&quot;status&quot;] == &quot;qualified&quot;
    assert update_result[&quot;updated_fields&quot;] == [&quot;status&quot;, &quot;updated_at&quot;, &quot;updated_by&quot;]
</code></pre>
<p><strong>Run</strong>:</p>
<pre><code class="language-bash">uv run pytest tests/integration/actions/test_full_action_compilation.py -v
</code></pre>
<hr />
<h4 id="task-4-add-advanced-action-step-support">Task 4: Add Advanced Action Step Support</h4>
<p><strong>Priority Steps to Implement</strong>:</p>
<ol>
<li><strong>Call Steps</strong> - Invoke other functions</li>
</ol>
<pre><code class="language-python"># src/generators/actions/step_compilers/call_compiler.py

class CallStepCompiler:
    &quot;&quot;&quot;Compile call steps (invoke other functions)&quot;&quot;&quot;

    def compile(self, step: ActionStep, entity: Entity) -&gt; str:
        &quot;&quot;&quot;
        Compile: call: function_name(args)

        Example SpecQL:
          - call: send_notification(owner_email, &quot;Contact qualified&quot;)

        Generated SQL:
          PERFORM app.send_notification(
              p_email := owner_email,
              p_message := 'Contact qualified'
          );
        &quot;&quot;&quot;
        function_name = step.function_name
        args = step.args

        # Build argument list
        arg_sql = self._build_arguments(args)

        return f&quot;&quot;&quot;
    -- Call: {function_name}
    PERFORM app.{function_name}({arg_sql});
&quot;&quot;&quot;
</code></pre>
<ol>
<li><strong>Notify Steps</strong> - Event emission</li>
</ol>
<pre><code class="language-python"># src/generators/actions/step_compilers/notify_compiler.py

class NotifyStepCompiler:
    &quot;&quot;&quot;Compile notify steps (event emission)&quot;&quot;&quot;

    def compile(self, step: ActionStep, entity: Entity) -&gt; str:
        &quot;&quot;&quot;
        Compile: notify: recipient(channel, message)

        Example SpecQL:
          - notify: owner(email, &quot;Contact qualified&quot;)

        Generated SQL:
          PERFORM app.emit_event(
              p_tenant_id := auth_tenant_id,
              p_event_type := 'notification',
              p_payload := jsonb_build_object(
                  'recipient', owner_email,
                  'channel', 'email',
                  'message', 'Contact qualified'
              )
          );
        &quot;&quot;&quot;
        recipient = step.recipient
        channel = step.channel
        message = step.message

        return f&quot;&quot;&quot;
    -- Notify: {recipient} via {channel}
    PERFORM app.emit_event(
        p_tenant_id := auth_tenant_id,
        p_event_type := 'notification.{channel}',
        p_payload := jsonb_build_object(
            'recipient', {recipient},
            'channel', '{channel}',
            'message', '{message}',
            'entity', '{{{{ entity.name | lower }}}}',
            'entity_id', v_{{{{ entity.name | lower }}}}_id
        )
    );
&quot;&quot;&quot;
</code></pre>
<ol>
<li><strong>For Each Steps</strong> - Iteration</li>
</ol>
<pre><code class="language-python"># src/generators/actions/step_compilers/foreach_compiler.py

class ForEachStepCompiler:
    &quot;&quot;&quot;Compile for_each steps (iteration)&quot;&quot;&quot;

    def compile(self, step: ActionStep, entity: Entity) -&gt; str:
        &quot;&quot;&quot;
        Compile: for_each: collection DO steps

        Example SpecQL:
          - for_each: items
            steps:
              - update: MachineItem SET status = 'allocated'

        Generated SQL:
          FOR v_item IN
              SELECT * FROM crm.tb_machine_item
              WHERE fk_reservation = v_reservation_pk
          LOOP
              UPDATE crm.tb_machine_item
              SET status = 'allocated',
                  updated_at = now(),
                  updated_by = auth_user_id
              WHERE pk_machine_item = v_item.pk_machine_item;
          END LOOP;
        &quot;&quot;&quot;
</code></pre>
<hr />
<h4 id="task-5-error-handling-validation">Task 5: Error Handling &amp; Validation</h4>
<p><strong>Add</strong>: SQL injection protection in expression compiler</p>
<pre><code class="language-python"># src/generators/actions/expression_compiler.py

class ExpressionCompiler:
    &quot;&quot;&quot;Compile SpecQL expressions to safe SQL&quot;&quot;&quot;

    SAFE_OPERATORS = {'=', '!=', '&lt;', '&gt;', '&lt;=', '&gt;=', 'AND', 'OR', 'NOT', 'IN', 'LIKE'}
    SAFE_FUNCTIONS = {'UPPER', 'LOWER', 'TRIM', 'LENGTH', 'COALESCE', 'NOW'}

    def compile(self, expression: str, entity: Entity) -&gt; str:
        &quot;&quot;&quot;Compile expression with SQL injection protection&quot;&quot;&quot;
        # Parse expression tree
        ast = self._parse_expression(expression)

        # Validate all operators and functions
        self._validate_safety(ast)

        # Convert to SQL
        return self._ast_to_sql(ast, entity)

    def _validate_safety(self, ast: ExpressionNode):
        &quot;&quot;&quot;Ensure expression only uses safe operators/functions&quot;&quot;&quot;
        if ast.type == &quot;function&quot;:
            if ast.name.upper() not in self.SAFE_FUNCTIONS:
                raise SecurityError(
                    f&quot;Function '{ast.name}' not allowed in expressions. &quot;
                    f&quot;Allowed: {self.SAFE_FUNCTIONS}&quot;
                )
        # Recursively validate children
        for child in ast.children:
            self._validate_safety(child)
</code></pre>
<hr />
<h3 id="medium-term-next-week-3-5-days"><strong>MEDIUM TERM (Next Week) - 3-5 days</strong></h3>
<h4 id="task-6-advanced-action-orchestration">Task 6: Advanced Action Orchestration</h4>
<p><strong>Implement</strong>: <code>ActionOrchestrator</code> for complex multi-entity actions</p>
<pre><code class="language-python"># src/generators/actions/action_orchestrator.py

class ActionOrchestrator:
    &quot;&quot;&quot;Orchestrate complex actions involving multiple entities&quot;&quot;&quot;

    def compile_multi_entity_action(
        self,
        action: Action,
        primary_entity: Entity,
        related_entities: List[Entity]
    ) -&gt; str:
        &quot;&quot;&quot;
        Compile actions that affect multiple entities

        Example:
          Action: create_reservation
            - Creates Reservation
            - Creates multiple Allocations
            - Updates MachineItem statuses
            - Sends notifications
        &quot;&quot;&quot;
        # Compile in transaction
        sql_parts = [
            &quot;BEGIN;&quot;,
            self._compile_primary_insert(action, primary_entity),
            *[self._compile_related_insert(step, ent)
              for step, ent in zip(action.steps, related_entities)],
            self._compile_side_effects(action),
            &quot;COMMIT;&quot;,
        ]

        return &quot;\n&quot;.join(sql_parts)
</code></pre>
<hr />
<h4 id="task-7-performance-optimization">Task 7: Performance Optimization</h4>
<p><strong>Add</strong>: Query optimization hints and indexing suggestions</p>
<pre><code class="language-python"># src/generators/actions/performance_optimizer.py

class PerformanceOptimizer:
    &quot;&quot;&quot;Analyze and optimize generated functions&quot;&quot;&quot;

    def optimize_query(self, sql: str, entity: Entity) -&gt; str:
        &quot;&quot;&quot;Add performance optimizations to generated SQL&quot;&quot;&quot;

        # Add query hints for FK lookups
        sql = self._add_index_hints(sql, entity)

        # Suggest indexes for common query patterns
        indexes = self._suggest_indexes(sql, entity)

        # Add EXPLAIN ANALYZE comments for debugging
        sql = self._add_explain_comments(sql)

        return sql, indexes

    def _suggest_indexes(self, sql: str, entity: Entity) -&gt; List[str]:
        &quot;&quot;&quot;Suggest indexes based on query patterns&quot;&quot;&quot;
        suggestions = []

        # Suggest covering index for common WHERE clauses
        if &quot;WHERE tenant_id = &quot; in sql and &quot;AND status = &quot; in sql:
            suggestions.append(
                f&quot;CREATE INDEX idx_{entity.name.lower()}_tenant_status &quot;
                f&quot;ON {entity.schema}.tb_{entity.name.lower()}(tenant_id, status)&quot;
            )

        return suggestions
</code></pre>
<hr />
<h3 id="long-term-next-2-weeks-full-production-readiness"><strong>LONG TERM (Next 2 Weeks) - Full Production Readiness</strong></h3>
<h4 id="task-8-complete-documentation">Task 8: Complete Documentation</h4>
<p><strong>Create</strong>:
1. <code>docs/teams/TEAM_C_ACTION_COMPILER_GUIDE.md</code> - Developer guide
2. <code>docs/teams/TEAM_C_TESTING_GUIDE.md</code> - Testing strategies
3. <code>docs/teams/TEAM_C_TROUBLESHOOTING.md</code> - Common issues &amp; fixes
4. <code>docs/examples/complex_actions/</code> - Real-world examples</p>
<h4 id="task-9-fraiseql-integration-testing">Task 9: FraiseQL Integration Testing</h4>
<p><strong>Verify</strong>: Generated functions work with FraiseQL introspection</p>
<pre><code class="language-bash"># Generate schema
uv run python -m src.cli.generate entities/*.yaml

# Apply to database
psql -f migrations/*.sql

# Run FraiseQL introspection
fraiseql introspect --database postgres://localhost/test

# Verify mutations exist
fraiseql schema --output schema.graphql
grep &quot;mutation createContact&quot; schema.graphql
</code></pre>
<h4 id="task-10-performance-benchmarking">Task 10: Performance Benchmarking</h4>
<p><strong>Benchmark</strong>: Generated functions against hand-written equivalents</p>
<pre><code class="language-python"># tests/benchmarks/test_action_performance.py

def test_generated_vs_handwritten_performance(benchmark):
    &quot;&quot;&quot;Compare generated function performance to hand-written&quot;&quot;&quot;

    # Generated function
    generated_time = benchmark(lambda: execute_generated_create_contact())

    # Hand-written equivalent
    handwritten_time = benchmark(lambda: execute_handwritten_create_contact())

    # Should be within 10% performance
    assert generated_time &lt;= handwritten_time * 1.1
</code></pre>
<hr />
<h2 id="complete-task-checklist">üìã COMPLETE TASK CHECKLIST</h2>
<h3 id="immediate-today">Immediate (Today)</h3>
<ul>
<li>[ ] Fix test: <code>test_generate_core_create_function</code> (5 min)</li>
<li>[ ] Add <code>app.log_and_return_mutation()</code> to Team B generator (30 min)</li>
<li>[ ] Run all Team C tests, ensure 100% passing (5 min)</li>
<li>[ ] Commit: "fix(Team C): Correct test expectation for app.log_and_return_mutation"</li>
</ul>
<h3 id="short-term-this-week">Short Term (This Week)</h3>
<ul>
<li>[ ] Write integration test: <code>test_full_create_contact_compilation</code> (2 hours)</li>
<li>[ ] Write integration test: <code>test_trinity_resolution_in_action</code> (1 hour)</li>
<li>[ ] Write integration test: <code>test_update_action_compilation</code> (1 hour)</li>
<li>[ ] Implement <code>CallStepCompiler</code> (3 hours)</li>
<li>[ ] Implement <code>NotifyStepCompiler</code> (2 hours)</li>
<li>[ ] Implement <code>ForEachStepCompiler</code> (4 hours)</li>
<li>[ ] Add SQL injection protection (2 hours)</li>
<li>[ ] Run full integration test suite (30 min)</li>
</ul>
<h3 id="medium-term-next-week">Medium Term (Next Week)</h3>
<ul>
<li>[ ] Implement <code>ActionOrchestrator</code> for multi-entity actions (6 hours)</li>
<li>[ ] Add <code>PerformanceOptimizer</code> (4 hours)</li>
<li>[ ] Test complex real-world scenarios (4 hours)</li>
<li>[ ] Performance benchmarking (2 hours)</li>
<li>[ ] Edge case testing (4 hours)</li>
</ul>
<h3 id="long-term-next-2-weeks">Long Term (Next 2 Weeks)</h3>
<ul>
<li>[ ] Complete developer documentation (8 hours)</li>
<li>[ ] FraiseQL integration testing (4 hours)</li>
<li>[ ] Production readiness checklist (2 hours)</li>
<li>[ ] Security audit (4 hours)</li>
<li>[ ] Final code review (4 hours)</li>
</ul>
<hr />
<h2 id="priority-ranking">üéØ PRIORITY RANKING</h2>
<h3 id="p0-critical-must-fix-immediately"><strong>P0 - CRITICAL (Must fix immediately)</strong></h3>
<ol>
<li>‚úÖ Fix failing test (DONE - just needs commit)</li>
<li>üî¥ Add <code>app.log_and_return_mutation()</code> to Team B generator</li>
</ol>
<h3 id="p1-high-this-week"><strong>P1 - HIGH (This week)</strong></h3>
<ol>
<li>Integration tests (prove it works end-to-end)</li>
<li>Call/Notify step compilers (needed for real actions)</li>
<li>SQL injection protection (security critical)</li>
</ol>
<h3 id="p2-medium-next-week"><strong>P2 - MEDIUM (Next week)</strong></h3>
<ol>
<li>Multi-entity action support</li>
<li>Performance optimization</li>
<li>Advanced error handling</li>
</ol>
<h3 id="p3-low-nice-to-have"><strong>P3 - LOW (Nice to have)</strong></h3>
<ol>
<li>For-each loops</li>
<li>Complex expression parsing</li>
<li>Transaction control</li>
</ol>
<hr />
<h2 id="success-metrics">üìä SUCCESS METRICS</h2>
<h3 id="definition-of-done-for-team-c"><strong>Definition of "Done" for Team C</strong></h3>
<ul>
<li>[ ] ‚úÖ All unit tests passing (100%)</li>
<li>[ ] ‚úÖ All integration tests passing (minimum 5 scenarios)</li>
<li>[ ] ‚úÖ Generated SQL executes in PostgreSQL without errors</li>
<li>[ ] ‚úÖ FraiseQL successfully introspects generated functions</li>
<li>[ ] ‚úÖ Performance within 10% of hand-written functions</li>
<li>[ ] ‚úÖ Security audit passed (no SQL injection vulnerabilities)</li>
<li>[ ] ‚úÖ Documentation complete (developer guide, examples, troubleshooting)</li>
<li>[ ] ‚úÖ Code review approved</li>
<li>[ ] ‚úÖ Production deployment ready</li>
</ul>
<h3 id="current-progress-85"><strong>Current Progress</strong>: 85%</h3>
<pre><code>Phase 1: App/Core Generation     [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%
Phase 2: Action Compilation      [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë]  80%
Phase 3: Step Compilers          [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]  70%
Phase 4: Integration Testing     [‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]   0%
Phase 5: Advanced Features       [‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]   0%
Phase 6: Production Readiness    [‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]  10%

Overall:                         [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë]  85%
</code></pre>
<hr />
<h2 id="recommended-work-sequence">üöÄ RECOMMENDED WORK SEQUENCE</h2>
<h3 id="week-1-now">Week 1 (Now)</h3>
<p><strong>Days 1-2</strong>: Fix test + Add helper function + Integration tests
<strong>Days 3-4</strong>: Call/Notify compilers + SQL injection protection
<strong>Day 5</strong>: Testing + Bug fixes</p>
<h3 id="week-2">Week 2</h3>
<p><strong>Days 1-2</strong>: Multi-entity actions
<strong>Days 3-4</strong>: Performance optimization + Edge cases
<strong>Day 5</strong>: Documentation + Code review</p>
<h3 id="week-3">Week 3</h3>
<p><strong>Days 1-2</strong>: FraiseQL integration testing
<strong>Days 3-5</strong>: Production readiness + Final polish</p>
<hr />
<p><strong>Status</strong>: Ready for final push to completion
<strong>Estimated Time to 100%</strong>: 2-3 weeks
<strong>Blocker</strong>: Team B must generate <code>app.log_and_return_mutation()</code> first</p>
<hr />
<p><strong>Last Updated</strong>: 2025-11-08
<strong>Next Review</strong>: After integration tests complete</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>pgTAP Tests - PostgreSQL Native Testing - SpecQL Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "pgTAP Tests - PostgreSQL Native Testing";
        var mkdocs_page_input_path = "guides/test-generation/pgtap-tests.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> SpecQL Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../getting-started/">Getting Started</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../mutation-patterns/">Mutation Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../">Test Generation</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../cli/">CLI</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../reference/">Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../examples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../tutorials/">Tutorials</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../best-practices/">Best Practices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">SpecQL Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">pgTAP Tests - PostgreSQL Native Testing</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="pgtap-tests-postgresql-native-testing">pgTAP Tests - PostgreSQL Native Testing</h1>
<p>pgTAP is SpecQL's PostgreSQL-native testing framework. Run comprehensive tests directly in the database without external dependencies. Test business logic, constraints, functions, and data integrity with native SQL performance.</p>
<h2 id="what-youll-learn">üéØ What You'll Learn</h2>
<ul>
<li>pgTAP testing fundamentals</li>
<li>Generate and run database-level tests</li>
<li>Test patterns, constraints, and functions</li>
<li>Debug test failures</li>
<li>Performance and best practices</li>
</ul>
<h2 id="prerequisites">üìã Prerequisites</h2>
<ul>
<li><a href="../getting-started/installation.md">SpecQL installed</a></li>
<li><a href="../getting-started/first-entity.md">Entity with patterns created</a></li>
<li>PostgreSQL with pgTAP extension</li>
<li>Basic SQL knowledge</li>
</ul>
<h2 id="pgtap-fundamentals">üí° pgTAP Fundamentals</h2>
<h3 id="what-is-pgtap">What is pgTAP?</h3>
<p><strong>pgTAP</strong> is a unit testing framework for PostgreSQL that allows you to:
- ‚úÖ <strong>Write tests in SQL</strong> - No external languages required
- ‚úÖ <strong>Test database objects</strong> - Functions, constraints, triggers
- ‚úÖ <strong>Run tests in-database</strong> - Direct PostgreSQL execution
- ‚úÖ <strong>Get TAP output</strong> - Standard test protocol
- ‚úÖ <strong>Integrate with CI/CD</strong> - Works with any test runner</p>
<h3 id="why-pgtap-for-specql">Why pgTAP for SpecQL?</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>pgTAP</th>
<th>pytest</th>
<th>Traditional SQL Tests</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Performance</strong></td>
<td>‚ö° Fastest</td>
<td>üêå Slower</td>
<td>‚ö° Fast</td>
</tr>
<tr>
<td><strong>Setup</strong></td>
<td>‚úÖ None</td>
<td>üõ†Ô∏è Python deps</td>
<td>‚úÖ None</td>
</tr>
<tr>
<td><strong>Coverage</strong></td>
<td>‚úÖ Database logic</td>
<td>‚úÖ App logic</td>
<td>‚ö†Ô∏è Limited</td>
</tr>
<tr>
<td><strong>Maintenance</strong></td>
<td>‚úÖ Auto-generated</td>
<td>‚úÖ Auto-generated</td>
<td>üõ†Ô∏è Manual</td>
</tr>
<tr>
<td><strong>CI/CD</strong></td>
<td>‚úÖ Native</td>
<td>‚úÖ Python</td>
<td>üõ†Ô∏è Custom</td>
</tr>
</tbody>
</table>
<h2 id="step-1-install-pgtap">üöÄ Step 1: Install pgTAP</h2>
<h3 id="install-extension">Install Extension</h3>
<pre><code class="language-bash"># Install pgTAP extension
psql $DATABASE_URL -c &quot;CREATE EXTENSION IF NOT EXISTS pgtap;&quot;

# Verify installation
psql $DATABASE_URL -c &quot;SELECT pgtap.version();&quot;
</code></pre>
<h3 id="alternative-installation-methods">Alternative Installation Methods</h3>
<h4 id="using-pgxn">Using pgxn</h4>
<pre><code class="language-bash"># Install via pgxn client
pgxn install pgtap
pgxn load pgtap -d mydatabase
</code></pre>
<h4 id="manual-installation">Manual Installation</h4>
<pre><code class="language-bash"># Download and install manually
wget https://github.com/theory/pgtap/archive/master.zip
unzip master.zip
cd pgtap-master
make
make install
make installcheck
</code></pre>
<h4 id="docker-installation">Docker Installation</h4>
<pre><code class="language-bash"># Use PostgreSQL with pgTAP pre-installed
docker run --name postgres-pgtap \
  -e POSTGRES_DB=mydb \
  -e POSTGRES_USER=myuser \
  -e POSTGRES_PASSWORD=mypass \
  -p 5432:5432 \
  -d theory/pgtap:latest
</code></pre>
<h2 id="step-2-generate-pgtap-tests">üß™ Step 2: Generate pgTAP Tests</h2>
<h3 id="create-test-entity">Create Test Entity</h3>
<pre><code class="language-yaml"># entities/order.yaml
name: order
fields:
  id: uuid
  customer_id: uuid
  status: string
  total_amount: decimal
  created_at: timestamp

patterns:
  - name: state_machine
    description: &quot;Order processing workflow&quot;
    initial_state: pending
    states: [pending, confirmed, shipped, delivered]
    transitions:
      - from: pending
        to: confirmed
        trigger: confirm
        guard: &quot;total_amount &gt; 0&quot;
      - from: confirmed
        to: shipped
        trigger: ship
      - from: shipped
        to: delivered
        trigger: deliver

  - name: validation
    description: &quot;Order validation rules&quot;
    rules:
      - name: positive_total
        field: total_amount
        rule: &quot;total_amount &gt; 0&quot;
        message: &quot;Order total must be positive&quot;
</code></pre>
<h3 id="generate-tests">Generate Tests</h3>
<pre><code class="language-bash"># Generate pgTAP tests
specql generate tests --type pgtap entities/order.yaml

# Check generated files
ls -la tests/pgtap/
# order_state_machine_test.sql
# order_validation_test.sql
</code></pre>
<h3 id="generated-test-structure">Generated Test Structure</h3>
<pre><code class="language-sql">-- tests/pgtap/order_state_machine_test.sql
BEGIN;

-- Setup test data
INSERT INTO order (id, customer_id, status, total_amount)
VALUES ('test-order-id', 'test-customer-id', 'pending', 100.00);

-- Test 1: Initial state verification
SELECT ok(
    (SELECT status FROM order WHERE id = 'test-order-id') = 'pending',
    'Order starts in pending state'
);

-- Test 2: Valid transition
SELECT ok(
    order_confirm('test-order-id') IS NOT NULL,
    'Can confirm order from pending state'
);

-- Test 3: State change verification
SELECT ok(
    (SELECT status FROM order WHERE id = 'test-order-id') = 'confirmed',
    'Order status changes to confirmed after confirmation'
);

-- Test 4: Invalid transition prevention
SELECT ok(
    order_ship('test-order-id') IS NULL,
    'Cannot ship unconfirmed order'
);

-- Test 5: Guard condition enforcement
UPDATE order SET total_amount = 0 WHERE id = 'test-order-id';
SELECT ok(
    order_confirm('test-order-id') IS NULL,
    'Cannot confirm order with zero total'
);

-- Cleanup
DELETE FROM order WHERE id = 'test-order-id';

ROLLBACK;
</code></pre>
<h2 id="step-3-run-pgtap-tests">üèÉ Step 3: Run pgTAP Tests</h2>
<h3 id="basic-test-execution">Basic Test Execution</h3>
<pre><code class="language-bash"># Run all pgTAP tests for entity
specql test run --type pgtap entities/order.yaml

# Expected output:
# order_state_machine_test.sql
# 1..5
# ok 1 - Order starts in pending state
# ok 2 - Can confirm order from pending state
# ok 3 - Order status changes to confirmed after confirmation
# ok 4 - Cannot ship unconfirmed order
# ok 5 - Cannot confirm order with zero total
</code></pre>
<h3 id="manual-test-execution">Manual Test Execution</h3>
<pre><code class="language-bash"># Run tests directly with psql
psql $DATABASE_URL -f tests/pgtap/order_state_machine_test.sql

# Run multiple test files
psql $DATABASE_URL -f tests/pgtap/order_state_machine_test.sql \
                   -f tests/pgtap/order_validation_test.sql
</code></pre>
<h3 id="advanced-execution-options">Advanced Execution Options</h3>
<pre><code class="language-bash"># Run with verbose output
specql test run --type pgtap entities/order.yaml --verbose

# Run specific test file
specql test run --type pgtap entities/order.yaml --filter &quot;*state_machine*&quot;

# Generate TAP output for CI/CD
specql test run --type pgtap entities/order.yaml --tap-output results.tap

# Run tests in parallel (if multiple entities)
specql test run --type pgtap entities/*.yaml --parallel
</code></pre>
<h2 id="step-4-understand-pgtap-assertions">üìä Step 4: Understand pgTAP Assertions</h2>
<h3 id="core-assertions">Core Assertions</h3>
<table>
<thead>
<tr>
<th>Assertion</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ok(boolean, description)</code></td>
<td>Test passes if true</td>
<td><code>ok(1=1, 'Math works')</code></td>
</tr>
<tr>
<td><code>is(actual, expected, desc)</code></td>
<td>Exact equality</td>
<td><code>is(status, 'active')</code></td>
</tr>
<tr>
<td><code>isnt(actual, unexpected, desc)</code></td>
<td>Inequality</td>
<td><code>isnt(status, 'deleted')</code></td>
</tr>
<tr>
<td><code>cmp_ok(left, op, right, desc)</code></td>
<td>Comparison</td>
<td><code>cmp_ok(total, '&gt;', 0)</code></td>
</tr>
</tbody>
</table>
<h3 id="database-specific-assertions">Database-Specific Assertions</h3>
<pre><code class="language-sql">-- Table and column assertions
SELECT has_table('order');
SELECT has_column('order', 'status');
SELECT col_is_pk('order', 'id');
SELECT col_is_fk('order', 'customer_id');

-- Constraint assertions
SELECT has_check('order', 'positive_total');
SELECT check_is('order', 'positive_total', 'total_amount &gt; 0');

-- Function assertions
SELECT has_function('order_confirm');
SELECT function_returns('order_confirm', 'uuid', 'order_result');

-- Index assertions
SELECT has_index('order', 'idx_order_status');
SELECT index_is_unique('order', 'idx_order_customer_status');
</code></pre>
<h3 id="business-logic-assertions">Business Logic Assertions</h3>
<pre><code class="language-sql">-- State machine testing
SELECT ok(
    order_can_transition('order-id', 'confirm'),
    'Order can transition to confirmed'
);

SELECT ok(
    NOT order_can_transition('order-id', 'ship'),
    'Order cannot transition to shipped from current state'
);

-- Validation testing
SELECT ok(
    validate_order_data('order-id'),
    'Order data passes validation'
);

-- Performance assertions
SELECT cmp_ok(
    (SELECT count(*) FROM order WHERE status = 'pending'), '&lt;', 1000,
    'Pending orders count is reasonable'
);
</code></pre>
<h2 id="step-5-debug-test-failures">üîç Step 5: Debug Test Failures</h2>
<h3 id="common-failure-patterns">Common Failure Patterns</h3>
<h4 id="test-setup-issues">Test Setup Issues</h4>
<pre><code class="language-sql">-- Check test data exists
SELECT * FROM order WHERE id = 'test-order-id';

-- Verify test isolation
SELECT count(*) FROM order;  -- Should be 1 in test
</code></pre>
<h4 id="assertion-failures">Assertion Failures</h4>
<pre><code class="language-sql">-- Debug state machine issues
SELECT status FROM order WHERE id = 'test-order-id';
SELECT * FROM order_get_available_transitions('test-order-id');

-- Check guard conditions
SELECT total_amount &gt; 0 FROM order WHERE id = 'test-order-id';
</code></pre>
<h4 id="constraint-violations">Constraint Violations</h4>
<pre><code class="language-sql">-- Check for constraint conflicts
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conrelid = 'order'::regclass;

-- Test constraint manually
INSERT INTO order (id, status, total_amount)
VALUES ('debug-id', 'pending', -100);
-- Should fail with constraint violation
</code></pre>
<h3 id="debugging-workflow">Debugging Workflow</h3>
<pre><code class="language-bash"># 1. Run test with verbose output
specql test run --type pgtap entities/order.yaml --verbose

# 2. Check test data setup
psql $DATABASE_URL -c &quot;
BEGIN;
INSERT INTO order (id, customer_id, status, total_amount)
VALUES ('debug-order', 'debug-customer', 'pending', 100.00);
SELECT * FROM order WHERE id = 'debug-order';
ROLLBACK;
&quot;

# 3. Test individual assertions
psql $DATABASE_URL -c &quot;
BEGIN;
INSERT INTO order (id, customer_id, status, total_amount)
VALUES ('debug-order', 'debug-customer', 'pending', 100.00);

-- Test each assertion manually
SELECT (SELECT status FROM order WHERE id = 'debug-order') = 'pending';
SELECT order_confirm('debug-order') IS NOT NULL;
SELECT (SELECT status FROM order WHERE id = 'debug-order') = 'confirmed';

ROLLBACK;
&quot;

# 4. Check generated functions
psql $DATABASE_URL -c &quot;\df order_confirm&quot;
psql $DATABASE_URL -c &quot;SELECT pg_get_functiondef('order_confirm'::regproc);&quot;
</code></pre>
<h2 id="step-6-performance-testing-with-pgtap">üìà Step 6: Performance Testing with pgTAP</h2>
<h3 id="performance-assertions">Performance Assertions</h3>
<pre><code class="language-sql">-- Query performance tests
SELECT cmp_ok(
    (SELECT extract(epoch from now() - query_start) FROM (
        SELECT now() as query_start,
               (SELECT count(*) FROM order WHERE status = 'pending') as result
    ) q), '&lt;', 0.1,
    'Order count query executes in under 100ms'
);

-- Function performance tests
SELECT ok(
    (SELECT extract(epoch from (
        SELECT now() - clock_timestamp() +
               order_confirm('test-order-id')::interval
    )) &lt; 0.5),
    'Order confirmation completes in under 500ms'
);
</code></pre>
<h3 id="load-testing">Load Testing</h3>
<pre><code class="language-sql">-- Bulk operation performance
SELECT cmp_ok(
    (SELECT extract(epoch from (
        SELECT now() - clock_timestamp() FROM (
            SELECT count(order_bulk_update_status(order_ids, 'confirmed'))
            FROM (SELECT array_agg(id) as order_ids FROM order LIMIT 1000) q
        ) timing
    ))), '&lt;', 5.0,
    'Bulk update of 1000 orders completes in under 5 seconds'
);
</code></pre>
<h3 id="index-performance-tests">Index Performance Tests</h3>
<pre><code class="language-sql">-- Index usage verification
SELECT ok(
    EXISTS (
        SELECT 1 FROM pg_stat_user_indexes
        WHERE relname = 'order' AND indexrelname = 'idx_order_status'
        AND idx_scan &gt; 0
    ),
    'Status index is being used'
);

-- Query plan analysis
SELECT ok(
    NOT EXISTS (
        SELECT 1 FROM pg_stat_statements
        WHERE query LIKE '%SELECT * FROM order WHERE status =%'
        AND mean_time &gt; 1000000  -- Over 1 second
    ),
    'Order status queries are fast'
);
</code></pre>
<h2 id="step-7-customize-pgtap-tests">üîß Step 7: Customize pgTAP Tests</h2>
<h3 id="test-configuration">Test Configuration</h3>
<pre><code class="language-yaml"># In your entity YAML
name: order
# ... fields and patterns ...

test_config:
  pgtap:
    # Test isolation
    schema: test_schema  # Run tests in separate schema

    # Data setup
    fixtures:
      - name: test_customer
        table: customer
        data:
          id: test-customer-id
          name: Test Customer

      - name: test_order
        table: order
        data:
          id: test-order-id
          customer_id: test-customer-id
          status: pending
          total_amount: 100.00

    # Test categories
    categories:
      - unit: Test individual functions
      - integration: Test function interactions
      - performance: Test execution speed

    # Custom assertions
    custom_assertions:
      - name: order_is_valid
        sql: &quot;SELECT order_meets_business_rules(id) FROM order WHERE id = $1&quot;
</code></pre>
<h3 id="custom-test-templates">Custom Test Templates</h3>
<pre><code class="language-sql">-- Custom test template for complex scenarios
CREATE OR REPLACE FUNCTION test_order_workflow()
RETURNS SETOF TEXT AS $$
DECLARE
    order_id UUID := gen_random_uuid();
    customer_id UUID := gen_random_uuid();
BEGIN
    -- Setup
    INSERT INTO customer (id, name) VALUES (customer_id, 'Test Customer');
    INSERT INTO order (id, customer_id, status, total_amount)
    VALUES (order_id, customer_id, 'pending', 150.00);

    -- Test complete workflow
    RETURN NEXT ok(order_confirm(order_id) IS NOT NULL, 'Can confirm order');
    RETURN NEXT is((SELECT status FROM order WHERE id = order_id), 'confirmed', 'Status updated');

    RETURN NEXT ok(order_ship(order_id) IS NOT NULL, 'Can ship confirmed order');
    RETURN NEXT is((SELECT status FROM order WHERE id = order_id), 'shipped', 'Order shipped');

    RETURN NEXT ok(order_deliver(order_id) IS NOT NULL, 'Can deliver shipped order');
    RETURN NEXT is((SELECT status FROM order WHERE id = order_id), 'delivered', 'Order delivered');

    -- Cleanup
    DELETE FROM order WHERE id = order_id;
    DELETE FROM customer WHERE id = customer_id;
END;
$$ LANGUAGE plpgsql;
</code></pre>
<h2 id="step-8-cicd-integration">üîÑ Step 8: CI/CD Integration</h2>
<h3 id="github-actions-example">GitHub Actions Example</h3>
<pre><code class="language-yaml"># .github/workflows/pgtap-tests.yml
name: pgTAP Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: &gt;-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Install SpecQL
        run: pip install specql

      - name: Setup pgTAP
        run: |
          psql postgresql://postgres:postgres@localhost:5432/postgres -c &quot;CREATE EXTENSION pgtap;&quot;

      - name: Generate Schema
        run: specql generate schema entities/*.yaml

      - name: Apply Schema
        run: |
          psql postgresql://postgres:postgres@localhost:5432/postgres -f db/schema/00_foundation/*.sql
          psql postgresql://postgres:postgres@localhost:5432/postgres -f db/schema/10_tables/*.sql
          psql postgresql://postgres:postgres@localhost:5432/postgres -f db/schema/40_functions/*.sql

      - name: Generate pgTAP Tests
        run: specql generate tests --type pgtap entities/*.yaml

      - name: Run pgTAP Tests
        run: specql test run --type pgtap entities/*.yaml

      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: pgtap-results
          path: test-results/
</code></pre>
<h3 id="jenkins-pipeline">Jenkins Pipeline</h3>
<pre><code class="language-groovy">pipeline {
    agent any

    stages {
        stage('Setup Database') {
            steps {
                sh '''
                    docker run -d --name postgres-test \
                        -e POSTGRES_PASSWORD=test \
                        -p 5432:5432 postgres:15

                    sleep 10

                    psql postgresql://postgres:test@localhost:5432/postgres \
                        -c &quot;CREATE EXTENSION pgtap;&quot;
                '''
            }
        }

        stage('Generate Tests') {
            steps {
                sh 'specql generate tests --type pgtap entities/*.yaml'
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    specql test run --type pgtap entities/*.yaml \
                        --junit-xml results.xml
                '''
            }
            post {
                always {
                    junit 'results.xml'
                }
            }
        }
    }
}
</code></pre>
<h2 id="best-practices">üéØ Best Practices</h2>
<h3 id="test-design">Test Design</h3>
<ul>
<li><strong>Test one thing per assertion</strong> - Keep tests focused</li>
<li><strong>Use descriptive test names</strong> - Explain what each test validates</li>
<li><strong>Test edge cases</strong> - Include boundary conditions</li>
<li><strong>Isolate tests</strong> - Each test should be independent</li>
</ul>
<h3 id="performance">Performance</h3>
<ul>
<li><strong>Keep tests fast</strong> - pgTAP tests should run in seconds</li>
<li><strong>Use appropriate data sizes</strong> - Test with realistic data volumes</li>
<li><strong>Index test data</strong> - Ensure queries perform well</li>
<li><strong>Profile slow tests</strong> - Optimize bottlenecks</li>
</ul>
<h3 id="maintenance">Maintenance</h3>
<ul>
<li><strong>Regenerate tests regularly</strong> - Keep in sync with schema changes</li>
<li><strong>Review test failures</strong> - Understand root causes</li>
<li><strong>Update test expectations</strong> - When business logic changes</li>
<li><strong>Document complex tests</strong> - Explain non-obvious test logic</li>
</ul>
<h3 id="database-considerations">Database Considerations</h3>
<ul>
<li><strong>Use transactions</strong> - Isolate test data with BEGIN/ROLLBACK</li>
<li><strong>Clean up test data</strong> - Don't leave test artifacts</li>
<li><strong>Test constraints</strong> - Verify database integrity rules</li>
<li><strong>Check permissions</strong> - Ensure test user has required access</li>
</ul>
<h2 id="troubleshooting">üÜò Troubleshooting</h2>
<h3 id="pgtap-extension-not-found">"pgTAP extension not found"</h3>
<pre><code class="language-bash"># Check PostgreSQL version compatibility
psql $DATABASE_URL -c &quot;SELECT version();&quot;

# Install correct pgTAP version
# For PostgreSQL 15, use pgTAP 1.2.0+
</code></pre>
<h3 id="tests-pass-locally-but-fail-in-ci">"Tests pass locally but fail in CI"</h3>
<pre><code class="language-bash"># Check environment differences
# - PostgreSQL version
# - pgTAP version
# - Database collation
# - Timezone settings

# Use same versions in CI as local
# Test with CI database version locally
</code></pre>
<h3 id="test-data-conflicts">"Test data conflicts"</h3>
<pre><code class="language-sql">-- Use unique identifiers
INSERT INTO order (id, customer_id, status)
VALUES (gen_random_uuid(), gen_random_uuid(), 'pending');

-- Or use test-specific schemas
CREATE SCHEMA test_schema;
SET search_path TO test_schema;
</code></pre>
<h3 id="performance-tests-are-slow">"Performance tests are slow"</h3>
<pre><code class="language-sql">-- Reduce test data size
SELECT cmp_ok(
    (SELECT count(*) FROM order LIMIT 100), '&lt;', 100,
    'Sample query is fast'
);

-- Use EXPLAIN to optimize queries
EXPLAIN ANALYZE SELECT * FROM order WHERE status = 'pending';
</code></pre>
<h3 id="function-not-found-errors">"Function not found errors"</h3>
<pre><code class="language-bash"># Check function exists
psql $DATABASE_URL -c &quot;\df order_confirm&quot;

# Regenerate functions
specql generate schema entities/order.yaml --force

# Apply functions to database
psql $DATABASE_URL -f db/schema/40_functions/order_state_machine.sql
</code></pre>
<h2 id="success-metrics">üìä Success Metrics</h2>
<h3 id="test-quality-metrics">Test Quality Metrics</h3>
<ul>
<li><strong>Test execution time</strong>: &lt;30 seconds for full suite</li>
<li><strong>Test coverage</strong>: &gt;95% of database functions</li>
<li><strong>Assertion count</strong>: 10-20 assertions per pattern</li>
<li><strong>Failure rate</strong>: &lt;1% in stable branches</li>
</ul>
<h3 id="performance-benchmarks">Performance Benchmarks</h3>
<ul>
<li><strong>Simple queries</strong>: &lt;10ms average</li>
<li><strong>Complex functions</strong>: &lt;100ms average</li>
<li><strong>Bulk operations</strong>: &lt;5 seconds for 1000 records</li>
<li><strong>Index usage</strong>: &gt;90% of queries use appropriate indexes</li>
</ul>
<h3 id="reliability-goals">Reliability Goals</h3>
<ul>
<li><strong>Zero false positives</strong> - Tests only fail on real issues</li>
<li><strong>Consistent results</strong> - Same tests pass/fail across runs</li>
<li><strong>Fast feedback</strong> - Results available within 5 minutes</li>
<li><strong>CI stability</strong> - &lt;5% flaky tests</li>
</ul>
<h2 id="summary">üéâ Summary</h2>
<p>pgTAP testing provides:
- ‚úÖ <strong>Native PostgreSQL testing</strong> - No external dependencies
- ‚úÖ <strong>Comprehensive database coverage</strong> - Functions, constraints, triggers
- ‚úÖ <strong>Fast execution</strong> - Direct database performance
- ‚úÖ <strong>CI/CD integration</strong> - Standard TAP output
- ‚úÖ <strong>Auto-generated tests</strong> - Zero manual test writing</p>
<h2 id="whats-next">üöÄ What's Next?</h2>
<ul>
<li><strong><a href="../pytest-tests/">pytest Tests</a></strong> - Python integration testing</li>
<li><strong><a href="../performance-tests/">Performance Tests</a></strong> - Benchmarking and optimization</li>
<li><strong><a href="ci-cd-integration.md">CI/CD Integration</a></strong> - Automated testing pipelines</li>
<li><strong><a href="../best-practices/testing.md">Custom Test Patterns</a></strong> - Advanced testing techniques</li>
</ul>
<p><strong>Ready to achieve comprehensive database test coverage? Let's continue! üöÄ</strong></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

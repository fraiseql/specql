<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>State Machine Pattern - SpecQL Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "State Machine Pattern";
        var mkdocs_page_input_path = "guides/mutation-patterns/state-machines.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> SpecQL Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../getting-started/">Getting Started</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../">Mutation Patterns</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../test-generation/">Test Generation</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../cli/">CLI</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../reference/">Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../examples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../tutorials/">Tutorials</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../best-practices/">Best Practices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">SpecQL Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">State Machine Pattern</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="state-machine-pattern">State Machine Pattern</h1>
<p>The <strong>state machine</strong> pattern manages entity lifecycle and status transitions. It's perfect for workflows like order processing, user approvals, content publishing, and any process with defined states and transitions.</p>
<h2 id="what-youll-learn">üéØ What You'll Learn</h2>
<ul>
<li>State machine concepts and benefits</li>
<li>Configuring states and transitions</li>
<li>Guards, actions, and events</li>
<li>Testing state machines</li>
<li>Common use cases and patterns</li>
</ul>
<h2 id="prerequisites">üìã Prerequisites</h2>
<ul>
<li><a href="../getting-started/">Pattern basics</a></li>
<li>Understanding of entity lifecycles</li>
<li>Basic YAML knowledge</li>
</ul>
<h2 id="state-machine-concepts">üí° State Machine Concepts</h2>
<h3 id="what-are-state-machines">What Are State Machines?</h3>
<p>A <strong>state machine</strong> defines:
- <strong>States</strong> - Possible statuses (pending, approved, shipped)
- <strong>Transitions</strong> - Allowed status changes
- <strong>Triggers</strong> - Functions that cause transitions
- <strong>Guards</strong> - Conditions that must be met
- <strong>Actions</strong> - Side effects during transitions
- <strong>Events</strong> - Notifications emitted</p>
<h3 id="why-use-state-machines">Why Use State Machines?</h3>
<table>
<thead>
<tr>
<th>Benefit</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Consistency</strong></td>
<td>Enforced valid transitions</td>
<td>Can't ship unapproved orders</td>
</tr>
<tr>
<td><strong>Auditability</strong></td>
<td>Track all status changes</td>
<td>Who changed what when</td>
</tr>
<tr>
<td><strong>Automation</strong></td>
<td>Trigger actions on changes</td>
<td>Send email when order ships</td>
</tr>
<tr>
<td><strong>Safety</strong></td>
<td>Prevent invalid states</td>
<td>No "shipped" without "paid"</td>
</tr>
<tr>
<td><strong>Clarity</strong></td>
<td>Explicit business rules</td>
<td>Clear approval workflow</td>
</tr>
</tbody>
</table>
<h2 id="basic-state-machine">üèóÔ∏è Basic State Machine</h2>
<h3 id="simple-example">Simple Example</h3>
<pre><code class="language-yaml"># entities/order.yaml
name: order
fields:
  id: uuid
  status: string
  total: decimal

patterns:
  - name: state_machine
    description: &quot;Order processing workflow&quot;
    initial_state: pending
    states: [pending, confirmed, shipped, delivered, cancelled]
    transitions:
      - from: pending
        to: confirmed
        trigger: confirm
      - from: confirmed
        to: shipped
        trigger: ship
      - from: shipped
        to: delivered
        trigger: deliver
      - from: pending
        to: cancelled
        trigger: cancel
      - from: confirmed
        to: cancelled
        trigger: cancel
</code></pre>
<h3 id="generated-functions">Generated Functions</h3>
<pre><code class="language-sql">-- State transition functions
SELECT order_confirm(order_id);
SELECT order_ship(order_id);
SELECT order_deliver(order_id);
SELECT order_cancel(order_id);

-- Query functions
SELECT * FROM order_get_available_transitions(order_id);
SELECT order_can_transition(order_id, 'confirm');
SELECT order_get_current_state(order_id);
</code></pre>
<h2 id="advanced-configuration">‚öôÔ∏è Advanced Configuration</h2>
<h3 id="state-definitions">State Definitions</h3>
<pre><code class="language-yaml">patterns:
  - name: state_machine
    description: &quot;User account management&quot;
    initial_state: inactive

    # Detailed state configuration
    states:
      - name: inactive
        description: &quot;Account created but not verified&quot;
        color: &quot;gray&quot;
        metadata:
          can_login: false
          requires_verification: true

      - name: active
        description: &quot;Fully active account&quot;
        color: &quot;green&quot;
        metadata:
          can_login: true
          requires_verification: false

      - name: suspended
        description: &quot;Temporarily disabled&quot;
        color: &quot;red&quot;
        metadata:
          can_login: false
          suspension_reason: required

      - name: deactivated
        description: &quot;Permanently deactivated&quot;
        color: &quot;black&quot;
        metadata:
          can_login: false
          can_reactivate: false
</code></pre>
<h3 id="transition-configuration">Transition Configuration</h3>
<pre><code class="language-yaml">transitions:
  - from: inactive
    to: pending_verification
    trigger: request_verification
    description: &quot;Send verification email&quot;
    guard: &quot;email IS NOT NULL&quot;
    action: &quot;send_verification_email&quot;
    events: [&quot;user_verification_requested&quot;]
    metadata:
      estimated_duration: &quot;5 minutes&quot;

  - from: pending_verification
    to: active
    trigger: verify_email
    description: &quot;Complete email verification&quot;
    guard: &quot;verification_token IS NOT NULL&quot;
    action: &quot;send_welcome_email&quot;
    events: [&quot;user_activated&quot;]
    timeout: &quot;24 hours&quot;

  - from: active
    to: suspended
    trigger: suspend
    description: &quot;Suspend user account&quot;
    reason: &quot;Violation of terms of service&quot;
    action: &quot;send_suspension_notice&quot;
    events: [&quot;user_suspended&quot;]
    requires_permission: &quot;admin&quot;

  - from: suspended
    to: active
    trigger: reactivate
    description: &quot;Reactivate suspended account&quot;
    guard: &quot;suspension_reason_resolved = true&quot;
    action: &quot;send_reactivation_notice&quot;
    events: [&quot;user_reactivated&quot;]
</code></pre>
<h2 id="guards-and-conditions">üîí Guards and Conditions</h2>
<h3 id="precondition-guards">Precondition Guards</h3>
<p>Guards prevent invalid transitions:</p>
<pre><code class="language-yaml">transitions:
  - from: pending
    to: confirmed
    trigger: confirm
    guard: &quot;total_amount &gt; 0 AND payment_method IS NOT NULL&quot;

  - from: confirmed
    to: shipped
    trigger: ship
    guard: &quot;inventory_available = true AND shipping_address IS NOT NULL&quot;

  - from: any
    to: cancelled
    trigger: cancel
    guard: &quot;cancelled_by IN ('customer', 'admin')&quot;
</code></pre>
<p><strong>Guard Types:</strong>
- <strong>SQL expressions</strong> - <code>balance &gt; 100</code>
- <strong>Field checks</strong> - <code>status = 'active'</code>
- <strong>Function calls</strong> - <code>has_permission(user_id, 'cancel')</code>
- <strong>Complex logic</strong> - <code>age &gt;= 18 AND country IN ('US', 'CA')</code></p>
<h3 id="dynamic-guards">Dynamic Guards</h3>
<pre><code class="language-yaml">transitions:
  - from: draft
    to: published
    trigger: publish
    guard: |
      published_at IS NULL
      AND author_id = CURRENT_USER_ID()
      AND word_count &gt;= 100
      AND reviewed_by IS NOT NULL
</code></pre>
<h2 id="actions-and-side-effects">‚ö° Actions and Side Effects</h2>
<h3 id="transition-actions">Transition Actions</h3>
<p>Actions execute during transitions:</p>
<pre><code class="language-yaml">transitions:
  - from: pending
    to: confirmed
    trigger: confirm
    action: &quot;send_order_confirmation&quot;

  - from: confirmed
    to: shipped
    trigger: ship
    action: &quot;update_inventory&quot;

  - from: shipped
    to: delivered
    trigger: deliver
    actions:  # Multiple actions
      - &quot;send_delivery_notification&quot;
      - &quot;update_delivery_metrics&quot;
      - &quot;trigger_customer_survey&quot;
</code></pre>
<h3 id="action-functions">Action Functions</h3>
<p>Actions call custom functions:</p>
<pre><code class="language-sql">-- Generated action function
CREATE FUNCTION order_send_order_confirmation(order_id UUID)
RETURNS VOID AS $$
DECLARE
  customer_email TEXT;
  order_total DECIMAL;
BEGIN
  -- Get order details
  SELECT email, total INTO customer_email, order_total
  FROM customer c
  JOIN order o ON c.id = o.customer_id
  WHERE o.id = order_id;

  -- Send email
  PERFORM send_email(
    customer_email,
    'Order Confirmed',
    format('Your order totaling $%s has been confirmed', order_total)
  );
END;
$$ LANGUAGE plpgsql;
</code></pre>
<h2 id="events-and-notifications">üì¢ Events and Notifications</h2>
<h3 id="event-emission">Event Emission</h3>
<p>Events notify external systems:</p>
<pre><code class="language-yaml">transitions:
  - from: pending
    to: confirmed
    trigger: confirm
    events: [&quot;order_confirmed&quot;, &quot;payment_captured&quot;]

  - from: confirmed
    to: shipped
    trigger: ship
    events: [&quot;order_shipped&quot;]

  - from: shipped
    to: delivered
    trigger: deliver
    events: [&quot;order_delivered&quot;, &quot;customer_satisfaction_survey&quot;]
</code></pre>
<h3 id="event-handling">Event Handling</h3>
<p>Events use PostgreSQL NOTIFY:</p>
<pre><code class="language-sql">-- Listen for events
LISTEN order_events;

-- Event payload structure
{
  &quot;event&quot;: &quot;order_confirmed&quot;,
  &quot;entity_type&quot;: &quot;order&quot;,
  &quot;entity_id&quot;: &quot;123e4567-e89b-12d3-a456-426614174000&quot;,
  &quot;from_state&quot;: &quot;pending&quot;,
  &quot;to_state&quot;: &quot;confirmed&quot;,
  &quot;triggered_by&quot;: &quot;user_456&quot;,
  &quot;timestamp&quot;: &quot;2024-01-15T10:30:00Z&quot;,
  &quot;metadata&quot;: {
    &quot;order_total&quot;: 299.99,
    &quot;customer_id&quot;: &quot;789e0123-e89b-12d3-a456-426614174001&quot;
  }
}
</code></pre>
<h2 id="testing-state-machines">üß™ Testing State Machines</h2>
<h3 id="generated-tests">Generated Tests</h3>
<p>State machines generate comprehensive tests:</p>
<pre><code class="language-bash"># Generate tests
specql generate tests entities/order.yaml

# Run tests
specql test run entities/order.yaml
</code></pre>
<p><strong>Test Coverage:</strong>
- ‚úÖ <strong>Initial state</strong> - Entity starts correctly
- ‚úÖ <strong>Valid transitions</strong> - Allowed state changes work
- ‚úÖ <strong>Invalid transitions</strong> - Blocked changes fail
- ‚úÖ <strong>Guard conditions</strong> - Preconditions enforced
- ‚úÖ <strong>Actions executed</strong> - Side effects triggered
- ‚úÖ <strong>Events emitted</strong> - Notifications sent
- ‚úÖ <strong>Edge cases</strong> - Boundary conditions</p>
<h3 id="manual-testing">Manual Testing</h3>
<pre><code class="language-sql">-- Setup test data
INSERT INTO order (id, status, total)
VALUES ('test-order-id', 'pending', 100.00);

-- Test valid transition
SELECT order_confirm('test-order-id');
-- Should succeed

-- Check state changed
SELECT status FROM order WHERE id = 'test-order-id';
-- Should be 'confirmed'

-- Test invalid transition
SELECT order_ship('test-order-id');
-- Should fail (not confirmed yet)

-- Test with guard violation
UPDATE order SET total = 0 WHERE id = 'test-order-id';
SELECT order_confirm('test-order-id');
-- Should fail (guard: total &gt; 0)
</code></pre>
<h2 id="common-use-cases">üöÄ Common Use Cases</h2>
<h3 id="e-commerce-order">E-commerce Order</h3>
<pre><code class="language-yaml">patterns:
  - name: state_machine
    description: &quot;Order fulfillment process&quot;
    initial_state: pending
    states: [pending, confirmed, processing, shipped, delivered, cancelled, refunded]

    transitions:
      - from: pending
        to: confirmed
        trigger: confirm
        guard: &quot;payment_received = true&quot;

      - from: confirmed
        to: processing
        trigger: start_processing
        action: &quot;reserve_inventory&quot;

      - from: processing
        to: shipped
        trigger: ship
        action: &quot;update_tracking&quot;
        events: [&quot;order_shipped&quot;]

      - from: shipped
        to: delivered
        trigger: mark_delivered
        action: &quot;send_delivery_email&quot;

      - from: [pending, confirmed, processing]
        to: cancelled
        trigger: cancel
        action: &quot;refund_payment&quot;

      - from: delivered
        to: refunded
        trigger: refund
        guard: &quot;refund_eligible = true&quot;
</code></pre>
<h3 id="user-account-management">User Account Management</h3>
<pre><code class="language-yaml">patterns:
  - name: state_machine
    description: &quot;User lifecycle management&quot;
    initial_state: inactive
    states: [inactive, pending_verification, active, suspended, deactivated]

    transitions:
      - from: inactive
        to: pending_verification
        trigger: request_verification
        guard: &quot;email_verified = false&quot;
        action: &quot;send_verification_email&quot;

      - from: pending_verification
        to: active
        trigger: verify_email
        guard: &quot;verification_token_valid = true&quot;
        action: &quot;send_welcome_email&quot;

      - from: active
        to: suspended
        trigger: suspend
        reason: &quot;Policy violation&quot;
        action: &quot;send_suspension_notice&quot;

      - from: suspended
        to: active
        trigger: reactivate
        guard: &quot;violation_resolved = true&quot;

      - from: [active, suspended]
        to: deactivated
        trigger: deactivate
        action: &quot;send_deactivation_notice&quot;
</code></pre>
<h3 id="content-publishing">Content Publishing</h3>
<pre><code class="language-yaml">patterns:
  - name: state_machine
    description: &quot;Content publishing workflow&quot;
    initial_state: draft
    states: [draft, review, approved, published, archived]

    transitions:
      - from: draft
        to: review
        trigger: submit_for_review
        guard: &quot;word_count &gt;= 100&quot;

      - from: review
        to: approved
        trigger: approve
        guard: &quot;reviewed_by IS NOT NULL&quot;

      - from: approved
        to: published
        trigger: publish
        action: &quot;update_published_at&quot;

      - from: published
        to: archived
        trigger: archive
        guard: &quot;age_days &gt; 365&quot;

      - from: [draft, review, approved]
        to: archived
        trigger: reject
        action: &quot;notify_author&quot;
</code></pre>
<h2 id="best-practices">üéØ Best Practices</h2>
<h3 id="state-design">State Design</h3>
<ul>
<li><strong>Clear state names</strong> - Use descriptive, unambiguous names</li>
<li><strong>Logical progression</strong> - States should flow naturally</li>
<li><strong>Minimal states</strong> - Don't create unnecessary states</li>
<li><strong>Terminal states</strong> - Include end states (delivered, cancelled)</li>
</ul>
<h3 id="transition-design">Transition Design</h3>
<ul>
<li><strong>Explicit triggers</strong> - Clear function names (<code>confirm_order</code>, not <code>next</code>)</li>
<li><strong>Strong guards</strong> - Prevent invalid transitions</li>
<li><strong>Useful actions</strong> - Add value during transitions</li>
<li><strong>Informative events</strong> - Help external systems react</li>
</ul>
<h3 id="performance">Performance</h3>
<ul>
<li><strong>Index guard fields</strong> - Speed up precondition checks</li>
<li><strong>Cache state data</strong> - For frequently accessed entities</li>
<li><strong>Batch transitions</strong> - For bulk operations</li>
<li><strong>Monitor timeouts</strong> - Handle stuck transitions</li>
</ul>
<h3 id="maintenance">Maintenance</h3>
<ul>
<li><strong>Version transitions</strong> - Track workflow changes</li>
<li><strong>Document reasons</strong> - Explain guard conditions</li>
<li><strong>Test thoroughly</strong> - All paths and edge cases</li>
<li><strong>Monitor usage</strong> - Track transition frequencies</li>
</ul>
<h2 id="troubleshooting">üÜò Troubleshooting</h2>
<h3 id="transition-not-allowed">"Transition not allowed"</h3>
<pre><code class="language-sql">-- Check current state
SELECT status FROM order WHERE id = 'order-id';

-- Check available transitions
SELECT * FROM order_get_available_transitions('order-id');

-- Check guard conditions
SELECT total_amount &gt; 0 AND payment_received = true
FROM order WHERE id = 'order-id';
</code></pre>
<h3 id="action-function-not-found">"Action function not found"</h3>
<pre><code class="language-bash"># Regenerate after adding actions
specql generate schema entities/order.yaml --force

# Check function exists
psql $DATABASE_URL -c &quot;\df order_send_confirmation&quot;
</code></pre>
<h3 id="event-not-received">"Event not received"</h3>
<pre><code class="language-sql">-- Check event emission
LISTEN order_events;

-- Trigger transition
SELECT order_confirm('order-id');

-- Should see notification
-- NOTIFY order_events, '{&quot;event&quot;: &quot;order_confirmed&quot;, ...}';
</code></pre>
<h3 id="performance-issues">"Performance issues"</h3>
<pre><code class="language-yaml"># Add indexes for guards
indexes:
  - fields: [status]
  - fields: [total_amount]
  - fields: [payment_received]
    where: &quot;status = 'pending'&quot;
</code></pre>
<h2 id="summary">üéâ Summary</h2>
<p>State machines provide:
- ‚úÖ <strong>Structured workflows</strong> - Clear state progressions
- ‚úÖ <strong>Data integrity</strong> - Enforced valid transitions
- ‚úÖ <strong>Automatic actions</strong> - Side effects during changes
- ‚úÖ <strong>Event notifications</strong> - External system integration
- ‚úÖ <strong>Comprehensive testing</strong> - Full coverage out of the box</p>
<h2 id="whats-next">üöÄ What's Next?</h2>
<ul>
<li><strong><a href="../multi-entity/">Multi-Entity Operations</a></strong> - Cross-table transactions</li>
<li><strong><a href="../validation/">Validation</a></strong> - Data integrity patterns</li>
<li><strong><a href="../batch-operations/">Batch Operations</a></strong> - Bulk data processing</li>
<li><strong><a href="../../examples/">Examples</a></strong> - Real-world state machines</li>
</ul>
<p><strong>Ready to implement complex workflows? Let's continue! üöÄ</strong></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

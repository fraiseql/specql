name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target repository (testpypi or pypi)'
        required: true
        default: 'testpypi'
        type: choice
        options:
        - testpypi
        - pypi

permissions:
  contents: read
  id-token: write  # For trusted publishing

jobs:
  # Quality Gates - must pass before publishing
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install UV
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: |
        uv sync
        uv pip install -e ".[dev]"

    - name: Run tests
      run: |
        uv run pytest --cov=src --cov-report=xml --cov-report=term --tb=short

    - name: Check test coverage
      run: |
        COVERAGE=$(python -c "import xml.etree.ElementTree as ET; root = ET.parse('coverage.xml').getroot(); print(float(root.find('.//coverage').get('line-rate')) * 100)")
        echo "Coverage: ${COVERAGE}%"
        if (( $(echo "$COVERAGE < 90" | bc -l) )); then
          echo "âŒ Coverage too low: ${COVERAGE}% (minimum 90%)"
          exit 1
        fi
        echo "âœ… Coverage acceptable: ${COVERAGE}%"

    - name: Lint code
      run: uv run ruff check src/ tests/

    - name: Check formatting
      run: uv run ruff format --check src/ tests/

    - name: Type check
      run: uv run mypy src/

    - name: Security check
      run: |
        uv pip install bandit safety
        uv run bandit -r src/
        uv run safety check --json

  # Build verification
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    needs: quality-gate
    steps:
    - uses: actions/checkout@v4

    - name: Install UV
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install build tools
      run: uv pip install build twine

    - name: Build distribution packages
      run: python -m build

    - name: Verify built packages
      run: |
        ls -la dist/
        twine check dist/*

    - name: Test installation in clean environment
      run: |
        python -m venv test_install
        test_install/bin/pip install --upgrade pip

        # Test wheel installation
        test_install/bin/pip install --no-deps dist/*.whl
        test_install/bin/python -c "import specql_generator; print('âœ… Wheel import successful')"

        # Test source distribution
        test_install/bin/pip install --no-deps dist/*.tar.gz
        test_install/bin/python -c "import specql_generator; print('âœ… Source distribution import successful')"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

  # Determine target repository
  determine-target:
    name: Determine Target Repository
    runs-on: ubuntu-latest
    needs: build
    outputs:
      repository: ${{ steps.target.outputs.repository }}
      repository-url: ${{ steps.target.outputs.repository-url }}
    steps:
    - name: Determine repository
      id: target
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          TARGET="${{ inputs.target }}"
        else
          # For tagged releases, determine based on version
          VERSION="${GITHUB_REF#refs/tags/v}"
          if [[ "$VERSION" == *"-"* ]]; then
            TARGET="testpypi"
          else
            TARGET="pypi"
          fi
        fi

        if [[ "$TARGET" == "testpypi" ]]; then
          echo "repository=testpypi" >> $GITHUB_OUTPUT
          echo "repository-url=https://test.pypi.org/legacy/" >> $GITHUB_OUTPUT
        else
          echo "repository=pypi" >> $GITHUB_OUTPUT
          echo "repository-url=https://upload.pypi.org/legacy/" >> $GITHUB_OUTPUT
        fi

        echo "ðŸŽ¯ Publishing to: $TARGET"

  # Publish to PyPI
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build, determine-target]
    environment:
      name: ${{ needs.determine-target.outputs.repository == 'pypi' && 'production' || 'test' }}
    steps:
    - uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Install publishing tools
      run: pip install twine

    - name: Publish to PyPI
      run: |
        twine upload \
          --repository ${{ needs.determine-target.outputs.repository }} \
          --repository-url ${{ needs.determine-target.outputs.repository-url }} \
          --username __token__ \
          --password ${{ secrets.PYPI_API_TOKEN }} \
          dist/*

    - name: Verify publication
      run: |
        PACKAGE_NAME="specql-generator"
        if [[ "${{ needs.determine-target.outputs.repository }}" == "testpypi" ]]; then
          PACKAGE_URL="https://test.pypi.org/project/$PACKAGE_NAME/"
        else
          PACKAGE_URL="https://pypi.org/project/$PACKAGE_NAME/"
        fi

        echo "ðŸ“¦ Package published successfully!"
        echo "ðŸ”— View at: $PACKAGE_URL"

        # Wait a moment for package to be indexed
        sleep 10

        # Verify package is accessible
        if curl -s --head "$PACKAGE_URL" | grep "200 OK" > /dev/null; then
          echo "âœ… Package page is accessible"
        else
          echo "âš ï¸ Package page may not be ready yet"
        fi

  # Post-publish verification
  verify-installation:
    name: Verify Installation
    runs-on: ubuntu-latest
    needs: [publish, determine-target]
    steps:
    - name: Install from published package
      run: |
        python -m venv verify_install
        verify_install/bin/pip install --upgrade pip

        if [[ "${{ needs.determine-target.outputs.repository }}" == "testpypi" ]]; then
          verify_install/bin/pip install --index-url https://test.pypi.org/simple/ specql-generator
        else
          verify_install/bin/pip install specql-generator
        fi

    - name: Test CLI functionality
      run: |
        verify_install/bin/specql --help > /dev/null
        echo "âœ… CLI is functional"

        # Test basic validation
        verify_install/bin/specql validate entities/examples/simple_contract_manual.yaml
        echo "âœ… Validation works"

    - name: Test import
      run: |
        verify_install/bin/python -c "import specql_generator; print('âœ… Import successful')"
entity: Company
schema: crm
tier: multi_tenant
description: Company/organization records with relationship management

fields:
  # Basic Information
  name:
    type: text
    required: true
    description: Company legal name

  domain:
    type: text
    unique: true
    description: Primary company domain (e.g., acme.com)

  industry:
    type: enum(technology, finance, healthcare, retail, manufacturing, services, other)
    description: Primary industry vertical

  # Contact Information
  website:
    type: text
    description: Company website URL

  phone:
    type: text
    description: Main company phone

  email:
    type: text
    description: General company email

  # Business Details
  employee_count:
    type: integer
    description: Number of employees

  annual_revenue:
    type: money
    description: Annual revenue (composite type with amount/currency)

  # Status
  status:
    type: enum(prospect, active, inactive, churned)
    required: true
    default: prospect
    description: Company relationship status

  # Address (using composite type)
  headquarters:
    type: address
    description: HQ address (composite type with street/city/state/zip/country)

  # Metadata
  tags:
    type: list(text)
    description: Classification tags

  notes:
    type: text
    description: Additional notes

# Trinity Pattern Auto-Generated:
# - pk_company (INTEGER PRIMARY KEY)
# - id (UUID NOT NULL UNIQUE)
# - identifier (TEXT NOT NULL UNIQUE)
# - tenant_id (UUID NOT NULL) [multi_tenant schema]
# - created_at, updated_at, deleted_at (TIMESTAMPTZ)

actions:
  - name: activate_company
    description: Activate a prospect company
    parameters:
      company_id:
        type: uuid
        required: true
        description: Company UUID to activate

    impacts:
      - entity: Company
        operation: update
        fields: [status]
        description: Updates company status to active

    steps:
      - validate: |
          (SELECT status FROM crm.tb_company WHERE id = p_company_id) = 'prospect'
        error_message: Company must be a prospect to activate

      - update: |
          crm.tb_company
          SET status = 'active'
          WHERE id = p_company_id
        returning: company

  - name: mark_as_churned
    description: Mark an active company as churned
    parameters:
      company_id:
        type: uuid
        required: true
        description: Company UUID
      churn_reason:
        type: text
        required: true
        description: Reason for churn

    impacts:
      - entity: Company
        operation: update
        fields: [status, notes]
        description: Updates company status and adds churn reason

    steps:
      - validate: |
          (SELECT status FROM crm.tb_company WHERE id = p_company_id) = 'active'
        error_message: Only active companies can be marked as churned

      - update: |
          crm.tb_company
          SET
            status = 'churned',
            notes = COALESCE(notes, '') || E'\n--- CHURNED ---\n' || p_churn_reason
          WHERE id = p_company_id
        returning: company

  - name: update_revenue
    description: Update company annual revenue
    parameters:
      company_id:
        type: uuid
        required: true
        description: Company UUID
      revenue_amount:
        type: numeric
        required: true
        description: Revenue amount
      currency:
        type: text
        default: USD
        description: Currency code

    impacts:
      - entity: Company
        operation: update
        fields: [annual_revenue]
        description: Updates company revenue information

    steps:
      - validate: |
          p_revenue_amount >= 0
        error_message: Revenue must be non-negative

      - update: |
          crm.tb_company
          SET annual_revenue = ROW(p_revenue_amount, p_currency)::app.money
          WHERE id = p_company_id
        returning: company

  - name: assign_industry
    description: Categorize company by industry
    parameters:
      company_id:
        type: uuid
        required: true
        description: Company UUID
      industry_type:
        type: text
        required: true
        description: Industry classification

    impacts:
      - entity: Company
        operation: update
        fields: [industry]
        description: Updates company industry classification

    steps:
      - validate: |
          p_industry_type IN ('technology', 'finance', 'healthcare', 'retail', 'manufacturing', 'services', 'other')
        error_message: Invalid industry type

      - update: |
          crm.tb_company
          SET industry = p_industry_type
          WHERE id = p_company_id
        returning: company

# Table Views
views:
  - name: active_companies
    description: All active companies
    base_table: tb_company
    where: status = 'active' AND deleted_at IS NULL

  - name: prospect_companies
    description: All prospect companies
    base_table: tb_company
    where: status = 'prospect' AND deleted_at IS NULL

  - name: tech_companies
    description: All technology companies
    base_table: tb_company
    where: industry = 'technology' AND deleted_at IS NULL

# Hierarchical View Organization - Executive Summary

**Date**: 2025-11-12
**Status**: Ready for Implementation
**Estimated Effort**: 26-35 hours (3-4 days)

---

## Documents Created

1. **`20251112_code_format_FINAL.md`** - Complete code format specification
2. **`20251112_hierarchical_view_organization_REVISED.md`** - Full implementation plan
3. **`20251112_current_vs_target_comparison.md`** - Visual gap analysis
4. **`20251112_hierarchical_view_organization_summary.md`** - Quick reference

---

## The Gap (Simple Version)

### Current
```
output/
└── 200_table_views.sql    ← Everything in one file
```

### Target
```
0_schema/02_query_side/
└── 024_dim/0241_geo/
    └── 024130_tv_location.sql    ← One file per entity
```

---

## Code Format (FINAL UNDERSTANDING)

### Format: `0LDSEV` (6 digits, all single digits except schema prefix)

| Pos | Component | Values | Example |
|-----|-----------|--------|---------|
| 1 | Schema | `0` | `0` |
| 2 | Layer | `1-2` | `1` (write) or `2` (read) |
| 3 | Domain | `0-9` | `4` (dim) |
| 4 | Subdomain | `1-9` | `1` (geo) |
| 5 | Entity | `1-9` | `1` (location) |
| 6 | File | `1-9` | `2` (second file) |

### Example Breakdown

**Code**: `014112` (tb_location.sql)
```
0  1  4  1  1  2
│  │  │  │  │  └─ File 2 (main table vs info table)
│  │  │  │  └──── Entity 1 (location)
│  │  │  └─────── Subdomain 1 (geo)
│  │  └────────── Domain 4 (dimensions)
│  └───────────── Layer 1 (write_side)
└──────────────── Schema 0
```

**Path**:
```
0_schema/01_write_side/014_dim/0141_geo/01411_location/014112_tb_location.sql
```

---

## Critical Insight

**Entity sequences are INDEPENDENT per layer!**

- Write-side subdomain `geo` can have entities 1, 2, 3, 4...
- Read-side subdomain `geo` can ALSO have entities 1, 2, 3, 4... (different views!)
- They don't conflict because layer digit differs (`1` vs `2`)

**Example**:
```
Write: 014111 (tb_location_info), 014112 (tb_location)
Read:  024110 (v_location), 024120 (v_count), 024130 (tv_location)
       ↑                                        ↑
       Entity 1 on read-side                    Entity 3 on read-side
       NOT related to write-side entity 1
```

---

## Implementation Phases

### Phase 1: Registry Enhancement (6-8 hours)
- Add independent read-side entity tracking
- Separate `write_entities` and `read_entities` dicts
- Track next_write_entity and next_read_entity separately

### Phase 2: Path Generation (4-5 hours)
- Parse 6-digit codes
- Generate hierarchical paths
- Create directories automatically

### Phase 3: File Splitting (4-6 hours)
- Split monolithic output into individual files
- One file per tv_ entity
- Maintain topological order

### Phase 4: Orchestrator Integration (5-7 hours)
- Assign read-side codes during generation
- Output multiple files instead of one
- Persist registry automatically

### Phase 5: Migration & Validation (4-5 hours)
- Migrate existing registry to new schema
- Add validation for codes
- Prevent conflicts

### Phase 6: Documentation (3-4 hours)
- Architecture docs
- Examples
- Migration guides

**Total**: 26-35 hours

---

## Registry Schema (New Structure)

```yaml
domains:
  '4':  # Single digit domain
    name: dim
    subdomains:
      '1':  # Single digit subdomain
        name: geo

        # Write-side tracking
        next_write_entity: 3
        write_entities:
          location_info:
            entity_num: 1
            files:
              - code: '014111'
                type: tb_
          location:
            entity_num: 1  # Same entity, different file
            files:
              - code: '014112'
                type: tb_

        # Read-side tracking (INDEPENDENT!)
        next_read_entity: 4
        read_entities:
          v_location:
            entity_num: 1
            files:
              - code: '024110'
                type: v_
          v_count_allocations:
            entity_num: 2
            files:
              - code: '024120'
                type: v_
          tv_location:
            entity_num: 3
            files:
              - code: '024130'
                type: tv_
```

---

## Key Constraints

### Hard Limits (Single Digit Components)
- **10 domains** (0-9)
- **9 subdomains per domain** (1-9, 0 not used)
- **9 entities per subdomain per layer** (1-9)
- **9 files per entity** (1-9)

### Scalability
- For large systems, split into more subdomains
- Each subdomain can have 9 write entities + 9 read entities
- Consider hexadecimal (0-F) if limits hit (requires format change)

---

## What Changes in SpecQL

### Files to Create
```
src/generators/schema/read_side_path_generator.py
src/generators/schema/code_parser.py
src/registry/migrator.py
src/registry/validator.py
+ 8 new test files
+ 4 documentation files
```

### Files to Modify
```
src/generators/schema/naming_conventions.py  (DomainRegistry class)
src/generators/schema_orchestrator.py        (generate_table_views)
src/cli/orchestrator.py                      (lines 424-437)
registry/domain_registry.yaml                (schema extension)
```

### Backward Compatibility
- Add CLI flag: `--tv-output-mode=single|hierarchical`
- Default to `hierarchical` (new behavior)
- Keep `single` option for legacy

---

## Success Criteria

- [ ] `specql generate --include-tv` creates hierarchical structure
- [ ] Paths match: `0_schema/02_query_side/0{L}{D}_{domain}/0{L}{D}{S}_{subdomain}/{code}_tv_{entity}.sql`
- [ ] Registry assigns independent read-side codes
- [ ] Registry persists automatically
- [ ] All tests pass (unit + integration)
- [ ] Documentation complete
- [ ] Migration from old schema works

---

## Next Steps

1. **Review** this summary and all related docs
2. **Clarify** any questions about code format
3. **Create feature branch**: `feature/hierarchical-tv-organization`
4. **Begin Phase 1**: Registry enhancement

---

## Open Questions

1. Should we support hexadecimal (0-F) for entities or enforce 9-entity limit?
2. How to handle migration of existing 200_table_views.sql to hierarchical?
3. Should subdomain 0 be allowed or reserved?
4. CLI flag naming: `--tv-output-mode` or `--tv-structure`?

---

**All implementation details in**: `20251112_hierarchical_view_organization_REVISED.md`
**Code format specification**: `20251112_code_format_FINAL.md`
**Visual comparison**: `20251112_current_vs_target_comparison.md`

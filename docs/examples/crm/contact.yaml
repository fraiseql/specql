# CRM Contact Entity Example
# This example demonstrates a complete CRM contact entity with state management,
# audit trails, and lead qualification workflow.

entity: Contact
namespace: crm
description: "Customer and prospect contact information with lead lifecycle management"

patterns:
  - state_machine:
      states: [prospect, qualified, customer, lost]
      initial_state: prospect
      transitions:
        qualify: { from: prospect, to: qualified }
        convert: { from: qualified, to: customer }
        lose: { from: [prospect, qualified], to: lost }
  - audit_trail:
      track_versions: true
      track_user: true
  - soft_delete
  - search_optimization:
      full_text_fields: [first_name, last_name, email, company]
      autocomplete: true

fields:
  # Basic contact information
  first_name:
    type: text
    required: true
    description: "Contact's first name"

  last_name:
    type: text
    required: true
    description: "Contact's last name"

  email:
    type: text
    required: true
    unique: true
    description: "Primary email address"

  phone:
    type: text
    description: "Primary phone number"

  # Company information
  company:
    type: text
    description: "Company or organization name"

  job_title:
    type: text
    description: "Job title or role"

  # Lead scoring and qualification
  lead_score:
    type: integer
    default: 0
    min: 0
    max: 100
    description: "Lead qualification score (0-100)"

  lead_source:
    type: enum
    values: [website, referral, advertisement, cold_call, trade_show, social_media, other]
    description: "How this lead was acquired"

  # Additional contact details
  linkedin_url:
    type: text
    description: "LinkedIn profile URL"

  twitter_handle:
    type: text
    description: "Twitter handle"

  # Address information
  address_street:
    type: text
    description: "Street address"

  address_city:
    type: text
    description: "City"

  address_state:
    type: text
    description: "State or province"

  address_postal_code:
    type: text
    description: "Postal or ZIP code"

  address_country:
    type: text
    default: "US"
    description: "Country code (ISO 2-letter)"

  # Communication preferences
  email_opt_in:
    type: boolean
    default: true
    description: "Opt-in for email marketing"

  sms_opt_in:
    type: boolean
    default: false
    description: "Opt-in for SMS marketing"

  # Qualification timestamps
  qualified_at:
    type: timestamptz
    description: "When lead was qualified"

  converted_at:
    type: timestamptz
    description: "When lead was converted to customer"

actions:
  - name: create_contact
    description: "Create a new contact with validation"
    parameters:
      first_name: text
      last_name: text
      email: text
      phone: text
      company: text
      lead_source: text
    steps:
      - type: validate
        condition: "first_name IS NOT NULL AND length(trim(first_name)) > 0"
        error_message: "First name is required"

      - type: validate
        condition: "last_name IS NOT NULL AND length(trim(last_name)) > 0"
        error_message: "Last name is required"

      - type: validate
        condition: "email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z]{2,}$'"
        error_message: "Invalid email format"

      - type: duplicate_check
        table: crm.tb_contact
        fields: [email]
        error_message: "Contact with this email already exists"

      - type: insert
        table: crm.tb_contact
        data:
          first_name: "{{ first_name }}"
          last_name: "{{ last_name }}"
          email: "{{ email }}"
          phone: "{{ phone }}"
          company: "{{ company }}"
          lead_source: "{{ lead_source }}"
          state: "'prospect'"

  - name: update_contact
    description: "Update contact information"
    parameters:
      contact_id: uuid
      first_name: text
      last_name: text
      email: text
      phone: text
      company: text
      job_title: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM crm.tb_contact WHERE id = {{ contact_id }} AND deleted_at IS NULL)"
        error_message: "Contact not found"

      - type: validate
        condition: "email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z]{2,}$'"
        error_message: "Invalid email format"

      - type: duplicate_check
        table: crm.tb_contact
        fields: [email]
        where: "id != {{ contact_id }}"
        error_message: "Another contact with this email already exists"

      - type: update
        table: crm.tb_contact
        data:
          first_name: "{{ first_name }}"
          last_name: "{{ last_name }}"
          email: "{{ email }}"
          phone: "{{ phone }}"
          company: "{{ company }}"
          job_title: "{{ job_title }}"
        where: "id = {{ contact_id }}"

  - name: qualify_lead
    description: "Qualify a prospect as a sales lead"
    parameters:
      contact_id: uuid
      lead_score: integer
      notes: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM crm.tb_contact WHERE id = {{ contact_id }} AND state = 'prospect' AND deleted_at IS NULL)"
        error_message: "Contact not found or not a prospect"

      - type: validate
        condition: "{{ lead_score }} >= 50"
        error_message: "Lead score must be at least 50 to qualify"

      - type: update
        table: crm.tb_contact
        data:
          state: "'qualified'"
          lead_score: "{{ lead_score }}"
          qualified_at: "NOW()"
        where: "id = {{ contact_id }}"

      - type: insert
        table: crm.tb_contact_history
        data:
          entity_id: "{{ contact_id }}"
          action: "'qualified'"
          old_values: jsonb_build_object('state', 'prospect')
          new_values: jsonb_build_object('state', 'qualified', 'lead_score', {{ lead_score }})
          notes: "{{ notes }}"

  - name: convert_to_customer
    description: "Convert a qualified lead to a customer"
    parameters:
      contact_id: uuid
      conversion_notes: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM crm.tb_contact WHERE id = {{ contact_id }} AND state = 'qualified' AND deleted_at IS NULL)"
        error_message: "Contact not found or not qualified"

      - type: update
        table: crm.tb_contact
        data:
          state: "'customer'"
          converted_at: "NOW()"
        where: "id = {{ contact_id }}"

      - type: insert
        table: crm.tb_contact_history
        data:
          entity_id: "{{ contact_id }}"
          action: "'converted'"
          old_values: jsonb_build_object('state', 'qualified')
          new_values: jsonb_build_object('state', 'customer')
          notes: "{{ conversion_notes }}"

  - name: update_lead_score
    description: "Update lead qualification score"
    parameters:
      contact_id: uuid
      lead_score: integer
      reason: text
    steps:
      - type: validate
        condition: "{{ lead_score }} >= 0 AND {{ lead_score }} <= 100"
        error_message: "Lead score must be between 0 and 100"

      - type: update
        table: crm.tb_contact
        data:
          lead_score: "{{ lead_score }}"
        where: "id = {{ contact_id }}"

      - type: insert
        table: crm.tb_contact_history
        data:
          entity_id: "{{ contact_id }}"
          action: "'score_updated'"
          old_values: jsonb_build_object('lead_score', (SELECT lead_score FROM crm.tb_contact WHERE id = {{ contact_id }}))
          new_values: jsonb_build_object('lead_score', {{ lead_score }})
          notes: "{{ reason }}"

  - name: search_contacts
    description: "Search contacts with full-text search"
    parameters:
      search_query: text
      limit: integer
      offset: integer
    steps:
      - type: assign
        variable_name: search_limit
        expression: "COALESCE({{ limit }}, 50)"

      - type: assign
        variable_name: search_offset
        expression: "COALESCE({{ offset }}, 0)"

      - type: select
        query: |
          SELECT id, first_name, last_name, email, company, lead_score, state,
                 ts_rank_cd(search_vector, plainto_tsquery('english', {{ search_query }})) as rank
          FROM crm.tb_contact
          WHERE search_vector @@ plainto_tsquery('english', {{ search_query }})
            AND deleted_at IS NULL
          ORDER BY rank DESC
          LIMIT {{ search_limit }} OFFSET {{ search_offset }}
        result_variable: search_results

      - type: return
        expression: jsonb_build_object(
          'results', search_results,
          'query', {{ search_query }},
          'limit', search_limit,
          'offset', search_offset
        )

  - name: get_contact_summary
    description: "Get contact summary with activity metrics"
    parameters:
      contact_id: uuid
    steps:
      - type: select
        query: |
          SELECT c.*,
                 COUNT(ch.id) as total_activities,
                 MAX(ch.changed_at) as last_activity
          FROM crm.tb_contact c
          LEFT JOIN crm.tb_contact_history ch ON c.id = ch.entity_id
          WHERE c.id = {{ contact_id }} AND c.deleted_at IS NULL
          GROUP BY c.id
        result_variable: contact_summary

      - type: return
        expression: contact_summary

# This example shows:
# - State machine pattern for lead lifecycle
# - Audit trail for all changes
# - Soft delete for data recovery
# - Search optimization for contact discovery
# - Comprehensive validation
# - Business logic actions for CRM workflows
# - Full-text search capabilities
# - Activity tracking and reporting
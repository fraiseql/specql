# Custom Project Task Entity Example
# This example demonstrates a custom business entity that combines multiple patterns
# for a comprehensive project management task system.

entity: Task
namespace: project
description: "Project management tasks with time tracking, dependencies, and workflow"

patterns:
  - state_machine:
      states: [backlog, ready, in_progress, in_review, completed, cancelled]
      initial_state: backlog
      transitions:
        ready: { from: backlog, to: ready }
        start: { from: ready, to: in_progress }
        review: { from: in_progress, to: in_review }
        complete: { from: [in_progress, in_review], to: completed }
        cancel: { from: [backlog, ready, in_progress, in_review], to: cancelled }
        reopen: { from: [completed, cancelled], to: backlog }
  - audit_trail:
      track_versions: true
      track_user: true
  - soft_delete
  - search_optimization:
      full_text_fields: [title, description, tags]
      autocomplete: true
      facets: [priority, status, assignee, project]
  - computed_fields:
      fields:
        - name: total_time_spent
          expression: "SELECT COALESCE(SUM(duration_minutes), 0) FROM project.tb_time_entry WHERE task_id = id AND deleted_at IS NULL"
          update_triggers: ["project.tb_time_entry.duration_minutes"]
        - name: completion_percentage
          expression: |
            CASE
              WHEN status = 'completed' THEN 100
              WHEN status = 'cancelled' THEN 0
              WHEN estimated_hours > 0 THEN LEAST(100, (total_time_spent / 60 / estimated_hours) * 100)
              ELSE 0
            END
          dependencies: [status, estimated_hours, total_time_spent]
  - notification:
      channels: [email, in_app]
      templates: true
      scheduling: true

fields:
  # Basic task information
  title:
    type: text
    required: true
    description: "Task title"

  description:
    type: text
    description: "Detailed task description"

  # Relationships
  project_id:
    type: uuid
    required: true
    indexed: true
    description: "Project this task belongs to"

  parent_task_id:
    type: uuid
    indexed: true
    description: "Parent task for subtasks"

  assignee_id:
    type: uuid
    indexed: true
    description: "User assigned to this task"

  reporter_id:
    type: uuid
    required: true
    description: "User who created this task"

  # Task properties
  priority:
    type: enum
    values: [lowest, low, medium, high, highest, critical]
    default: medium
    indexed: true
    description: "Task priority level"

  type:
    type: enum
    values: [task, bug, feature, improvement, epic, subtask]
    default: task
    description: "Task type"

  tags:
    type: text[]
    description: "Task tags for categorization"

  # Time tracking
  estimated_hours:
    type: numeric(6,2)
    min: 0
    description: "Estimated hours to complete"

  due_date:
    type: timestamptz
    description: "Task due date"

  started_at:
    type: timestamptz
    description: "When work actually started"

  completed_at:
    type: timestamptz
    description: "When task was completed"

  # Dependencies
  depends_on:
    type: uuid[]
    description: "Task IDs this task depends on"

  blocks:
    type: uuid[]
    description: "Task IDs that depend on this task"

  # Progress tracking
  story_points:
    type: integer
    min: 0
    max: 21
    description: "Agile story points (Fibonacci scale)"

  sprint_id:
    type: uuid
    indexed: true
    description: "Sprint this task is assigned to"

  # Quality assurance
  acceptance_criteria:
    type: text[]
    description: "Criteria for task completion"

  testing_notes:
    type: text
    description: "Testing notes and results"

  # Attachments and links
  attachments:
    type: jsonb
    description: "File attachments metadata"

  external_links:
    type: jsonb
    description: "Links to external resources"

actions:
  - name: create_task
    description: "Create a new task with validation"
    parameters:
      title: text
      description: text
      project_id: uuid
      assignee_id: uuid
      priority: text
      type: text
      estimated_hours: numeric
      due_date: timestamptz
      tags: text[]
      parent_task_id: uuid
    steps:
      - type: validate
        condition: "title IS NOT NULL AND length(trim(title)) > 0"
        error_message: "Task title is required"

      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_project WHERE id = {{ project_id }} AND deleted_at IS NULL)"
        error_message: "Project not found"

      - type: validate
        condition: "{{ assignee_id }} IS NULL OR EXISTS (SELECT 1 FROM auth.tb_user WHERE id = {{ assignee_id }})"
        error_message: "Assignee not found"

      - type: validate
        condition: "{{ parent_task_id }} IS NULL OR EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ parent_task_id }} AND deleted_at IS NULL)"
        error_message: "Parent task not found"

      - type: validate
        condition: "{{ due_date }} IS NULL OR {{ due_date }} > NOW()"
        error_message: "Due date must be in the future"

      - type: insert
        table: project.tb_task
        data:
          title: "{{ title }}"
          description: "{{ description }}"
          project_id: "{{ project_id }}"
          assignee_id: "{{ assignee_id }}"
          reporter_id: "{{ current_user_id }}"
          priority: "COALESCE({{ priority }}, 'medium')"
          type: "COALESCE({{ type }}, 'task')"
          estimated_hours: "{{ estimated_hours }}"
          due_date: "{{ due_date }}"
          tags: "{{ tags }}"
          parent_task_id: "{{ parent_task_id }}"
          state: "'backlog'"

  - name: update_task
    description: "Update task information"
    parameters:
      task_id: uuid
      title: text
      description: text
      assignee_id: uuid
      priority: text
      estimated_hours: numeric
      due_date: timestamptz
      tags: text[]
      story_points: integer
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ task_id }} AND deleted_at IS NULL)"
        error_message: "Task not found"

      - type: validate
        condition: "title IS NULL OR length(trim(title)) > 0"
        error_message: "Task title cannot be empty"

      - type: validate
        condition: "{{ assignee_id }} IS NULL OR EXISTS (SELECT 1 FROM auth.tb_user WHERE id = {{ assignee_id }})"
        error_message: "Assignee not found"

      - type: validate
        condition: "{{ due_date }} IS NULL OR {{ due_date }} > NOW()"
        error_message: "Due date must be in the future"

      - type: validate
        condition: "{{ story_points }} IS NULL OR {{ story_points }} IN (0,1,2,3,5,8,13,21)"
        error_message: "Story points must be Fibonacci numbers (0,1,2,3,5,8,13,21)"

      - type: update
        table: project.tb_task
        data:
          title: "{{ title }}"
          description: "{{ description }}"
          assignee_id: "{{ assignee_id }}"
          priority: "{{ priority }}"
          estimated_hours: "{{ estimated_hours }}"
          due_date: "{{ due_date }}"
          tags: "{{ tags }}"
          story_points: "{{ story_points }}"
        where: "id = {{ task_id }}"

  - name: start_task
    description: "Mark task as in progress and record start time"
    parameters:
      task_id: uuid
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ task_id }} AND state = 'ready' AND deleted_at IS NULL)"
        error_message: "Task not found or not ready to start"

      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ task_id }} AND assignee_id = {{ current_user_id }})"
        error_message: "Only the assigned user can start this task"

      - type: update
        table: project.tb_task
        data:
          state: "'in_progress'"
          started_at: "NOW()"
        where: "id = {{ task_id }}"

      - type: notify
        channel: in_app
        template: "task_started"
        recipients: ["{{ assignee_id }}"]
        data:
          task_id: "{{ task_id }}"
          task_title: "(SELECT title FROM project.tb_task WHERE id = {{ task_id }})"

  - name: log_time
    description: "Log time spent on a task"
    parameters:
      task_id: uuid
      duration_minutes: integer
      description: text
      date_worked: date
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ task_id }} AND deleted_at IS NULL)"
        error_message: "Task not found"

      - type: validate
        condition: "{{ duration_minutes }} > 0 AND {{ duration_minutes }} <= 480"
        error_message: "Duration must be between 1 and 480 minutes (8 hours)"

      - type: validate
        condition: "{{ date_worked }} <= CURRENT_DATE"
        error_message: "Cannot log time for future dates"

      - type: insert
        table: project.tb_time_entry
        data:
          task_id: "{{ task_id }}"
          user_id: "{{ current_user_id }}"
          duration_minutes: "{{ duration_minutes }}"
          description: "{{ description }}"
          date_worked: "{{ date_worked }}"
          logged_at: "NOW()"

  - name: add_dependency
    description: "Add a dependency between tasks"
    parameters:
      task_id: uuid
      depends_on_task_id: uuid
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ task_id }} AND deleted_at IS NULL)"
        error_message: "Task not found"

      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ depends_on_task_id }} AND deleted_at IS NULL)"
        error_message: "Dependency task not found"

      - type: validate
        condition: "{{ task_id }} != {{ depends_on_task_id }}"
        error_message: "Task cannot depend on itself"

      - type: validate
        condition: |
          NOT EXISTS (
            SELECT 1 FROM project.tb_task
            WHERE id = {{ depends_on_task_id }}
              AND {{ task_id }} = ANY(depends_on)
          )
        error_message: "Circular dependency detected"

      - type: update
        table: project.tb_task
        data:
          depends_on: "array_append(COALESCE(depends_on, ARRAY[]::uuid[]), {{ depends_on_task_id }})"
        where: "id = {{ task_id }}"

      - type: update
        table: project.tb_task
        data:
          blocks: "array_append(COALESCE(blocks, ARRAY[]::uuid[]), {{ task_id }})"
        where: "id = {{ depends_on_task_id }}"

  - name: complete_task
    description: "Mark task as completed with validation"
    parameters:
      task_id: uuid
      completion_notes: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM project.tb_task WHERE id = {{ task_id }} AND state IN ('in_progress', 'in_review') AND deleted_at IS NULL)"
        error_message: "Task not found or not in progress"

      - type: validate
        condition: |
          NOT EXISTS (
            SELECT 1 FROM project.tb_task
            WHERE id = {{ task_id }}
              AND depends_on IS NOT NULL
              AND NOT (SELECT bool_and(state = 'completed')
                      FROM project.tb_task
                      WHERE id = ANY((SELECT depends_on FROM project.tb_task WHERE id = {{ task_id }})))
          )
        error_message: "Cannot complete task with incomplete dependencies"

      - type: update
        table: project.tb_task
        data:
          state: "'completed'"
          completed_at: "NOW()"
        where: "id = {{ task_id }}"

      - type: insert
        table: project.tb_task_history
        data:
          task_id: "{{ task_id }}"
          action: "'completed'"
          notes: "{{ completion_notes }}"
          changed_by: "{{ current_user_id }}"

      - type: notify
        channel: in_app
        template: "task_completed"
        recipients: ["(SELECT reporter_id FROM project.tb_task WHERE id = {{ task_id }})"]
        data:
          task_id: "{{ task_id }}"
          completed_by: "{{ current_user_id }}"

  - name: search_tasks
    description: "Advanced task search with filtering"
    parameters:
      query: text
      project_id: uuid
      assignee_id: uuid
      status: text
      priority: text
      tags: text[]
      due_before: timestamptz
      due_after: timestamptz
      sort_by: text
      sort_order: text
      limit: integer
      offset: integer
    steps:
      - type: assign
        variable_name: search_limit
        expression: "COALESCE({{ limit }}, 50)"

      - type: assign
        variable_name: search_offset
        expression: "COALESCE({{ offset }}, 0)"

      - type: assign
        variable_name: sort_column
        expression: |
          CASE {{ sort_by }}
            WHEN 'priority' THEN 'priority_order'
            WHEN 'due_date' THEN 'due_date'
            WHEN 'created_at' THEN 'created_at'
            WHEN 'updated_at' THEN 'updated_at'
            ELSE 'created_at'
          END

      - type: assign
        variable_name: sort_direction
        expression: "CASE WHEN {{ sort_order }} = 'desc' THEN 'DESC' ELSE 'ASC' END"

      - type: select
        query: |
          SELECT
            t.*,
            CASE t.priority
              WHEN 'lowest' THEN 1
              WHEN 'low' THEN 2
              WHEN 'medium' THEN 3
              WHEN 'high' THEN 4
              WHEN 'highest' THEN 5
              WHEN 'critical' THEN 6
            END as priority_order,
            p.name as project_name,
            u_assignee.username as assignee_name,
            u_reporter.username as reporter_name,
            ts_rank_cd(t.search_vector, plainto_tsquery('english', COALESCE({{ query }}, ''))) as search_rank
          FROM project.tb_task t
          JOIN project.tb_project p ON t.project_id = p.id
          LEFT JOIN auth.tb_user u_assignee ON t.assignee_id = u_assignee.id
          LEFT JOIN auth.tb_user u_reporter ON t.reporter_id = u_reporter.id
          WHERE t.deleted_at IS NULL
            AND ({{ query }} IS NULL OR t.search_vector @@ plainto_tsquery('english', {{ query }}))
            AND ({{ project_id }} IS NULL OR t.project_id = {{ project_id }})
            AND ({{ assignee_id }} IS NULL OR t.assignee_id = {{ assignee_id }})
            AND ({{ status }} IS NULL OR t.state = {{ status }})
            AND ({{ priority }} IS NULL OR t.priority = {{ priority }})
            AND ({{ tags }} IS NULL OR t.tags && {{ tags }})
            AND ({{ due_before }} IS NULL OR t.due_date <= {{ due_before }})
            AND ({{ due_after }} IS NULL OR t.due_date >= {{ due_after }})
          ORDER BY
            CASE WHEN {{ query }} IS NOT NULL THEN search_rank ELSE 0 END DESC,
            {{ sort_column }} {{ sort_direction }}
          LIMIT {{ search_limit }} OFFSET {{ search_offset }}
        result_variable: tasks

      - type: return
        expression: jsonb_build_object(
          'tasks', tasks,
          'total_count', (
            SELECT count(*) FROM project.tb_task t
            WHERE t.deleted_at IS NULL
              AND ({{ project_id }} IS NULL OR t.project_id = {{ project_id }})
              AND ({{ assignee_id }} IS NULL OR t.assignee_id = {{ assignee_id }})
              AND ({{ status }} IS NULL OR t.state = {{ status }})
          ),
          'query', {{ query }},
          'filters', jsonb_build_object(
            'project_id', {{ project_id }},
            'assignee_id', {{ assignee_id }},
            'status', {{ status }},
            'priority', {{ priority }},
            'tags', {{ tags }},
            'due_before', {{ due_before }},
            'due_after', {{ due_after }}
          )
        )

  - name: get_task_details
    description: "Get complete task details with related data"
    parameters:
      task_id: uuid
    steps:
      - type: select
        query: |
          SELECT
            t.*,
            jsonb_build_object(
              'id', p.id,
              'name', p.name,
              'description', p.description
            ) as project,
            jsonb_build_object(
              'id', u_assignee.id,
              'username', u_assignee.username,
              'full_name', u_assignee.full_name
            ) as assignee,
            jsonb_build_object(
              'id', u_reporter.id,
              'username', u_reporter.username,
              'full_name', u_reporter.full_name
            ) as reporter,
            CASE
              WHEN t.parent_task_id IS NOT NULL THEN
                jsonb_build_object(
                  'id', pt.id,
                  'title', pt.title,
                  'status', pt.state
                )
              ELSE NULL
            END as parent_task,
            (
              SELECT jsonb_agg(
                jsonb_build_object(
                  'id', st.id,
                  'title', st.title,
                  'status', st.state,
                  'assignee', jsonb_build_object('username', u_sub.username)
                )
              )
              FROM project.tb_task st
              LEFT JOIN auth.tb_user u_sub ON st.assignee_id = u_sub.id
              WHERE st.parent_task_id = t.id AND st.deleted_at IS NULL
            ) as subtasks,
            (
              SELECT jsonb_agg(
                jsonb_build_object(
                  'id', te.id,
                  'user_id', te.user_id,
                  'duration_minutes', te.duration_minutes,
                  'description', te.description,
                  'date_worked', te.date_worked,
                  'logged_at', te.logged_at
                )
              )
              FROM project.tb_time_entry te
              WHERE te.task_id = t.id AND te.deleted_at IS NULL
              ORDER BY te.logged_at DESC
            ) as time_entries,
            (
              SELECT jsonb_agg(
                jsonb_build_object(
                  'id', dep.id,
                  'title', dep.title,
                  'status', dep.state
                )
              )
              FROM project.tb_task dep
              WHERE dep.id = ANY(t.depends_on) AND dep.deleted_at IS NULL
            ) as dependencies
          FROM project.tb_task t
          JOIN project.tb_project p ON t.project_id = p.id
          LEFT JOIN auth.tb_user u_assignee ON t.assignee_id = u_assignee.id
          LEFT JOIN auth.tb_user u_reporter ON t.reporter_id = u_reporter.id
          LEFT JOIN project.tb_task pt ON t.parent_task_id = pt.id
          WHERE t.id = {{ task_id }} AND t.deleted_at IS NULL
        result_variable: task_details

      - type: return
        expression: task_details

# Related tables that would be created:
# - tb_time_entry: Time tracking entries
# - tb_task_history: Task state changes and comments
# - tb_project: Project definitions
# - tb_sprint: Sprint definitions
# - auth.tb_user: User accounts

# This example demonstrates:
# - Complex state machine with multiple transitions
# - Task dependencies and blocking relationships
# - Time tracking and progress calculation
# - Advanced search with multiple filters
# - Hierarchical tasks (parent/child relationships)
# - Comprehensive audit trails
# - Notification system integration
# - Computed fields for progress tracking
# - Complex validation rules
# - Rich data relationships and aggregations
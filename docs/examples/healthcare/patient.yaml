# Healthcare Patient Entity Example
# This example demonstrates a HIPAA-compliant patient management system
# with medical records, appointments, and privacy controls.

entity: Patient
namespace: healthcare
description: "Patient information with medical records and privacy compliance"

patterns:
  - audit_trail:
      track_versions: true
      track_user: true
      retention_days: 2555  # 7 years for medical records
  - soft_delete
  - search_optimization:
      full_text_fields: [first_name, last_name, medical_record_number]
      autocomplete: true
  - validation_chain:
      rules:
        - name: valid_ssn
          condition: "ssn IS NULL OR ssn ~ '^\\d{3}-\\d{2}-\\d{4}$'"
          message: "SSN must be in format XXX-XX-XXXX"
        - name: valid_dob
          condition: "date_of_birth < CURRENT_DATE - INTERVAL '1 day'"
          message: "Date of birth must be in the past"
        - name: consent_required
          condition: "hipaa_consent = true"
          message: "HIPAA consent is required"

fields:
  # Patient identification
  medical_record_number:
    type: text
    required: true
    unique: true
    description: "Unique medical record number (MRN)"

  first_name:
    type: text
    required: true
    description: "Patient's first name"

  last_name:
    type: text
    required: true
    description: "Patient's last name"

  date_of_birth:
    type: date
    required: true
    description: "Patient's date of birth"

  gender:
    type: enum
    values: [male, female, other, unknown]
    description: "Patient's gender"

  # Contact information
  email:
    type: text
    description: "Patient's email address"

  phone_home:
    type: text
    description: "Home phone number"

  phone_mobile:
    type: text
    description: "Mobile phone number"

  # Address
  address_street:
    type: text
    description: "Street address"

  address_city:
    type: text
    description: "City"

  address_state:
    type: text
    description: "State"

  address_zip:
    type: text
    description: "ZIP code"

  # Emergency contact
  emergency_contact_name:
    type: text
    description: "Emergency contact name"

  emergency_contact_relationship:
    type: text
    description: "Relationship to patient"

  emergency_contact_phone:
    type: text
    description: "Emergency contact phone"

  # Insurance information
  insurance_provider:
    type: text
    description: "Insurance provider name"

  insurance_policy_number:
    type: text
    description: "Insurance policy number"

  insurance_group_number:
    type: text
    description: "Insurance group number"

  # Medical information
  blood_type:
    type: enum
    values: [A+, A-, B+, B-, AB+, AB-, O+, O-]
    description: "Patient's blood type"

  allergies:
    type: text[]
    description: "Known allergies"

  medications:
    type: text[]
    description: "Current medications"

  chronic_conditions:
    type: text[]
    description: "Chronic medical conditions"

  # Privacy and consent
  hipaa_consent:
    type: boolean
    required: true
    default: false
    description: "HIPAA privacy consent given"

  hipaa_consent_date:
    type: timestamptz
    description: "Date HIPAA consent was given"

  data_sharing_consent:
    type: boolean
    default: false
    description: "Consent for data sharing with other providers"

  # Status and flags
  is_active:
    type: boolean
    default: true
    description: "Whether patient is actively receiving care"

  preferred_language:
    type: text
    default: "en"
    description: "Patient's preferred language"

  # PHI (Protected Health Information) access controls
  phi_access_level:
    type: enum
    values: [full, limited, emergency_only]
    default: full
    description: "Level of PHI access granted"

actions:
  - name: register_patient
    description: "Register a new patient with HIPAA consent validation"
    parameters:
      medical_record_number: text
      first_name: text
      last_name: text
      date_of_birth: date
      gender: text
      email: text
      phone_mobile: text
      hipaa_consent: boolean
    steps:
      - type: validate
        condition: "medical_record_number IS NOT NULL AND length(trim(medical_record_number)) > 0"
        error_message: "Medical record number is required"

      - type: validate
        condition: "first_name IS NOT NULL AND length(trim(first_name)) > 0"
        error_message: "First name is required"

      - type: validate
        condition: "last_name IS NOT NULL AND length(trim(last_name)) > 0"
        error_message: "Last name is required"

      - type: validate
        condition: "{{ hipaa_consent }} = true"
        error_message: "HIPAA consent is required for patient registration"

      - type: duplicate_check
        table: healthcare.tb_patient
        fields: [medical_record_number]
        error_message: "Patient with this medical record number already exists"

      - type: duplicate_check
        table: healthcare.tb_patient
        fields: [email]
        error_message: "Patient with this email already exists"

      - type: insert
        table: healthcare.tb_patient
        data:
          medical_record_number: "{{ medical_record_number }}"
          first_name: "{{ first_name }}"
          last_name: "{{ last_name }}"
          date_of_birth: "{{ date_of_birth }}"
          gender: "{{ gender }}"
          email: "{{ email }}"
          phone_mobile: "{{ phone_mobile }}"
          hipaa_consent: "{{ hipaa_consent }}"
          hipaa_consent_date: "NOW()"

  - name: update_patient_demographics
    description: "Update patient demographic information"
    parameters:
      patient_id: uuid
      first_name: text
      last_name: text
      email: text
      phone_home: text
      phone_mobile: text
      address_street: text
      address_city: text
      address_state: text
      address_zip: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND deleted_at IS NULL)"
        error_message: "Patient not found"

      - type: validate
        condition: "first_name IS NOT NULL AND length(trim(first_name)) > 0"
        error_message: "First name is required"

      - type: validate
        condition: "last_name IS NOT NULL AND length(trim(last_name)) > 0"
        error_message: "Last name is required"

      - type: duplicate_check
        table: healthcare.tb_patient
        fields: [email]
        where: "id != {{ patient_id }}"
        error_message: "Another patient with this email already exists"

      - type: update
        table: healthcare.tb_patient
        data:
          first_name: "{{ first_name }}"
          last_name: "{{ last_name }}"
          email: "{{ email }}"
          phone_home: "{{ phone_home }}"
          phone_mobile: "{{ phone_mobile }}"
          address_street: "{{ address_street }}"
          address_city: "{{ address_city }}"
          address_state: "{{ address_state }}"
          address_zip: "{{ address_zip }}"
        where: "id = {{ patient_id }}"

  - name: update_medical_history
    description: "Update patient's medical history and conditions"
    parameters:
      patient_id: uuid
      blood_type: text
      allergies: text[]
      medications: text[]
      chronic_conditions: text[]
      notes: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND deleted_at IS NULL)"
        error_message: "Patient not found"

      - type: update
        table: healthcare.tb_patient
        data:
          blood_type: "{{ blood_type }}"
          allergies: "{{ allergies }}"
          medications: "{{ medications }}"
          chronic_conditions: "{{ chronic_conditions }}"
        where: "id = {{ patient_id }}"

      - type: insert
        table: healthcare.tb_medical_history
        data:
          patient_id: "{{ patient_id }}"
          event_type: "'history_update'"
          notes: "{{ notes }}"
          recorded_by: "{{ current_user_id }}"
          recorded_at: "NOW()"

  - name: update_insurance
    description: "Update patient insurance information"
    parameters:
      patient_id: uuid
      insurance_provider: text
      insurance_policy_number: text
      insurance_group_number: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND deleted_at IS NULL)"
        error_message: "Patient not found"

      - type: update
        table: healthcare.tb_patient
        data:
          insurance_provider: "{{ insurance_provider }}"
          insurance_policy_number: "{{ insurance_policy_number }}"
          insurance_group_number: "{{ insurance_group_number }}"
        where: "id = {{ patient_id }}"

  - name: schedule_appointment
    description: "Schedule an appointment for a patient"
    parameters:
      patient_id: uuid
      provider_id: uuid
      appointment_date: timestamptz
      appointment_type: text
      notes: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND deleted_at IS NULL)"
        error_message: "Patient not found"

      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_provider WHERE id = {{ provider_id }} AND active = true)"
        error_message: "Provider not found or inactive"

      - type: validate
        condition: "{{ appointment_date }} > NOW()"
        error_message: "Appointment date must be in the future"

      - type: validate
        condition: |
          NOT EXISTS (
            SELECT 1 FROM healthcare.tb_appointment
            WHERE provider_id = {{ provider_id }}
              AND appointment_date = {{ appointment_date }}
              AND status != 'cancelled'
          )
        error_message: "Provider is not available at this time"

      - type: insert
        table: healthcare.tb_appointment
        data:
          patient_id: "{{ patient_id }}"
          provider_id: "{{ provider_id }}"
          appointment_date: "{{ appointment_date }}"
          appointment_type: "{{ appointment_type }}"
          notes: "{{ notes }}"
          status: "'scheduled'"

  - name: record_vital_signs
    description: "Record patient vital signs during a visit"
    parameters:
      patient_id: uuid
      appointment_id: uuid
      blood_pressure_systolic: integer
      blood_pressure_diastolic: integer
      heart_rate: integer
      temperature_f: numeric
      weight_lbs: numeric
      height_inches: numeric
      oxygen_saturation: integer
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND deleted_at IS NULL)"
        error_message: "Patient not found"

      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_appointment WHERE id = {{ appointment_id }} AND patient_id = {{ patient_id }})"
        error_message: "Appointment not found for this patient"

      - type: insert
        table: healthcare.tb_vital_signs
        data:
          patient_id: "{{ patient_id }}"
          appointment_id: "{{ appointment_id }}"
          blood_pressure_systolic: "{{ blood_pressure_systolic }}"
          blood_pressure_diastolic: "{{ blood_pressure_diastolic }}"
          heart_rate: "{{ heart_rate }}"
          temperature_f: "{{ temperature_f }}"
          weight_lbs: "{{ weight_lbs }}"
          height_inches: "{{ height_inches }}"
          oxygen_saturation: "{{ oxygen_saturation }}"
          recorded_at: "NOW()"
          recorded_by: "{{ current_user_id }}"

  - name: search_patients
    description: "Search patients with HIPAA-compliant access controls"
    parameters:
      query: text
      limit: integer
      offset: integer
    steps:
      - type: assign
        variable_name: search_limit
        expression: "COALESCE({{ limit }}, 20)"

      - type: assign
        variable_name: search_offset
        expression: "COALESCE({{ offset }}, 0)"

      - type: select
        query: |
          SELECT
            p.id,
            p.medical_record_number,
            p.first_name,
            p.last_name,
            p.date_of_birth,
            p.email,
            p.phone_mobile,
            p.is_active,
            CASE
              WHEN p.phi_access_level = 'full' THEN
                jsonb_build_object(
                  'blood_type', p.blood_type,
                  'allergies', p.allergies,
                  'medications', p.medications,
                  'last_visit', (
                    SELECT MAX(appointment_date)
                    FROM healthcare.tb_appointment
                    WHERE patient_id = p.id AND status = 'completed'
                  )
                )
              ELSE NULL
            END as medical_summary
          FROM healthcare.tb_patient p
          WHERE p.deleted_at IS NULL
            AND p.hipaa_consent = true
            AND (
              {{ query }} IS NULL OR
              p.search_vector @@ plainto_tsquery('english', {{ query }}) OR
              p.medical_record_number ILIKE '%' || {{ query }} || '%'
            )
          ORDER BY
            CASE WHEN {{ query }} IS NOT NULL THEN
              ts_rank_cd(p.search_vector, plainto_tsquery('english', {{ query }}))
            ELSE 0 END DESC,
            p.last_name, p.first_name
          LIMIT {{ search_limit }} OFFSET {{ search_offset }}
        result_variable: patients

      - type: return
        expression: jsonb_build_object(
          'patients', patients,
          'query', {{ query }},
          'limit', search_limit,
          'offset', search_offset
        )

  - name: get_patient_chart
    description: "Get complete patient chart with medical history"
    parameters:
      patient_id: uuid
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND deleted_at IS NULL)"
        error_message: "Patient not found"

      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND phi_access_level = 'full')"
        error_message: "Insufficient PHI access level"

      - type: select
        query: |
          SELECT
            p.*,
            jsonb_agg(DISTINCT a.*) as appointments,
            jsonb_agg(DISTINCT vs.*) as vital_signs,
            jsonb_agg(DISTINCT mh.*) as medical_history
          FROM healthcare.tb_patient p
          LEFT JOIN healthcare.tb_appointment a ON p.id = a.patient_id
          LEFT JOIN healthcare.tb_vital_signs vs ON p.id = vs.patient_id
          LEFT JOIN healthcare.tb_medical_history mh ON p.id = mh.patient_id
          WHERE p.id = {{ patient_id }}
          GROUP BY p.id
        result_variable: patient_chart

      - type: return
        expression: patient_chart

  - name: deactivate_patient
    description: "Deactivate a patient record (soft delete with audit)"
    parameters:
      patient_id: uuid
      reason: text
    steps:
      - type: validate
        condition: "EXISTS (SELECT 1 FROM healthcare.tb_patient WHERE id = {{ patient_id }} AND deleted_at IS NULL)"
        error_message: "Patient not found"

      - type: update
        table: healthcare.tb_patient
        data:
          is_active: "false"
          deactivated_at: "NOW()"
          deactivated_by: "{{ current_user_id }}"
          deactivation_reason: "{{ reason }}"
        where: "id = {{ patient_id }}"

      - type: insert
        table: healthcare.tb_patient_history
        data:
          patient_id: "{{ patient_id }}"
          action: "'deactivated'"
          notes: "{{ reason }}"
          changed_by: "{{ current_user_id }}"

# Related tables that would be created:
# - tb_appointment: Patient appointments
# - tb_vital_signs: Vital signs measurements
# - tb_medical_history: Medical history events
# - tb_provider: Healthcare providers
# - tb_patient_history: Patient status changes

# This example demonstrates:
# - HIPAA compliance with consent management
# - PHI access controls and privacy
# - Medical record management
# - Appointment scheduling
# - Vital signs tracking
# - Comprehensive audit trails
# - Search with access controls
# - Validation chains for complex rules
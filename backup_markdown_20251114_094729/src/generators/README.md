# SQL Generators Module (Team B)

**Responsibility**: Generate PostgreSQL DDL and functions from Entity AST

## ğŸ¯ Objectives

Transform Entity AST into production-ready PostgreSQL:

```python
# Input: Entity AST (from Team A)
Entity(
    name='Contact',
    schema='crm',
    fields={'email': FieldDefinition(type='text')},
    actions=[Action(name='create_contact', steps=[...])]
)
```

â†“

```sql
-- Output: PostgreSQL DDL + Functions
CREATE TABLE crm.tb_contact (
    pk_contact INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id UUID DEFAULT gen_random_uuid() NOT NULL,
    email TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE FUNCTION crm.fn_create_contact(p_input JSONB)
RETURNS TABLE(success BOOLEAN, result JSONB, error TEXT)
AS $$ ... $$;
```

## ğŸ“‹ Components

### `table_generator.py` ğŸš§ TODO
Generate Trinity pattern tables:
- Primary key (`pk_*` INTEGER)
- UUID (`id` UUID)
- Business fields
- Foreign keys (INTEGER references)
- Audit fields (created_at, updated_at, deleted_at)
- Indexes and constraints

### `view_generator.py` ğŸš§ TODO
Generate FraiseQL views:
- JSON aggregation of entity data
- COMMENT annotations for FraiseQL
- Query-optimized structure

### `function_generator.py` ğŸš§ TODO
Generate CRUD functions:
- `fn_create_*` - INSERT with validation
- `fn_update_*` - UPDATE with change detection
- `fn_delete_*` - Soft delete
- Return standardized `mutation_result`

### `action_generator.py` ğŸš§ TODO
Generate SpecQL action functions:
- Parse action steps â†’ PL/pgSQL
- Compile SpecQL DSL to SQL
- Framework boilerplate (audit, events, permissions)

### `trigger_generator.py` ğŸš§ TODO
Generate group leader triggers:
- Auto-populate dependent fields
- Data coherence enforcement

### `sql_utils.py` ğŸš§ TODO
SQL formatting utilities:
- SQL pretty-printing
- Identifier quoting
- Comment generation

## ğŸ§ª Testing Strategy

### Unit Tests
```bash
make teamB-test
```

Test files:
- `test_table_generator.py` - Table DDL generation
- `test_view_generator.py` - View generation
- `test_function_generator.py` - CRUD functions
- `test_action_generator.py` - SpecQL action compilation
- `test_trigger_generator.py` - Trigger generation

### Integration Tests
- Apply generated SQL to test database
- Verify functions execute correctly
- Test data integrity constraints

## ğŸ”— Interface Contract

### Input
```python
from src.core.ast_models import Entity

def generate_table(entity: Entity) -> str:
    """Generate CREATE TABLE statement"""
```

### Output
```python
@dataclass
class GeneratedFile:
    table_code: str
    entity_name: str
    file_type: str  # 'table', 'view', 'function'
    content: str
    dependencies: List[str]
```

### Mock Data (for parallel development)
```python
# tests/fixtures/mock_entities.py
def mock_contact_entity() -> Entity:
    return Entity(
        name='Contact',
        schema='crm',
        fields={'email': FieldDefinition(name='email', type='text')}
    )
```

## ğŸš€ Getting Started

### 1. Use Mock AST (Day 1)
```python
# src/generators/table_generator.py
from tests.fixtures.mock_entities import mock_contact_entity

# Develop with mock data
entity = mock_contact_entity()
sql = generate_table(entity)
```

### 2. TDD Cycle
```bash
# RED: Write test
vim tests/unit/generators/test_table_generator.py

# GREEN: Implement
vim src/generators/table_generator.py

# REFACTOR: Clean up
vim src/generators/table_generator.py

# QA: Verify
make teamB-test
make lint
```

### 3. Integration (Week 2)
```python
# Use real AST from Team A
from src.core.specql_parser import SpecQLParser

parser = SpecQLParser()
entity = parser.parse(yaml_content)
sql = generate_table(entity)
```

## ğŸ“Š Progress Tracking

### Week 1 Goals
- [ ] `table_generator.py` - Trinity pattern tables
- [ ] `sql_utils.py` - SQL formatting
- [ ] Generate manufacturer table (POC entity)
- [ ] Apply to test database

### Week 2 Goals
- [ ] `function_generator.py` - CRUD functions
- [ ] `action_generator.py` - SpecQL action compilation
- [ ] `view_generator.py` - FraiseQL views
- [ ] `trigger_generator.py` - Group leader triggers

## ğŸ¤ Team Communication

### Daily Standup
Post in `#team-generators`:
```
**Yesterday**: Implemented table generation with Trinity pattern
**Today**: Adding foreign key generation
**Blockers**: Waiting for Team A Entity AST finalization
```

### Integration Points
- **Team A**: Entity AST structure (Week 1)
- **Team C**: File metadata format (Week 1)
- **Team D**: FraiseQL COMMENT format (Week 2)

## ğŸ“š Resources

- [Trinity Pattern Guide](../../docs/guides/trinity-pattern.md) (TODO)
- [PostgreSQL PL/pgSQL](https://www.postgresql.org/docs/current/plpgsql.html)
- [Jinja2 Templates](https://jinja.palletsprojects.com/)

## ğŸ¯ Current Status

**Phase**: Week 1 - Table Generation
**Progress**: 0% (Starting point)
**Next**: Create `table_generator.py` with tests
